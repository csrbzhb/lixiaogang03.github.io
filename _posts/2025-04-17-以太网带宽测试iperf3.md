---
layout:     post
title:      以太网带宽测试 iperf3
subtitle:   RK3588
date:       2025-04-17
author:     LXG
header-img: img/post-bg-board.jpg
catalog: true
tags:
    - rk3588
---

Rockchip_Developer_Guide_Linux_GMAC_RGMII_Delayline_CN.pdf

Rockchip_Developer_Guide_Ethernet_CN.pdf

## 以太网控制器和PHY芯片

| 模块             | 简称 | 作用                                       | 所在层            | 接口类型                |
|------------------|------|--------------------------------------------|--------------------|-------------------------|
| **以太网控制器** | MAC  | 数据链路层：帧的组装/解析、协议处理       | OSI 第2层（MAC层） | 内部总线（AXI、PCIe 等）|
| **PHY 芯片**     | PHY  | 物理层：数字信号 ↔ 电信号，负责物理传输   | OSI 第1层（物理层）| MII / RMII / RGMII 等   |

### MAC 控制器（以太网控制器）：
- 通常集成在 SoC 或主控芯片中（如 RK3588）
- 功能：
  - 以太网帧封装与解析
  - MAC 地址处理
  - DMA 缓冲与传输
  - TCP/UDP/IP 协议 offload 功能

### PHY 芯片：
- 独立硬件芯片（如 RTL8211F、AR8035）
- 功能：
  - 数字信号与电信号相互转换
  - 网络速度与双工协商（如 10/100/1000Mbps）
  - 信号调节、时钟恢复、线路驱动等

### ⚙️ MAC 与 PHY 的连接方式：

| 接口类型 | 描述                  | 适用速率 |
|----------|-----------------------|----------|
| MII      | 早期标准，支持百兆     | 10/100M  |
| RMII     | 精简型 MII，少引脚     | 10/100M  |
| RGMII    | 常见千兆连接方式       | 10/100/1000M |

**典型场景**

```

[ ARM SoC / RK3588 ]
        |
   ┌────┴────┐
   │  MAC 控制器 │
   └────┬────┘
        |
   [ RGMII / RMII 接口 ]
        |
   [ PHY 芯片：RTL8211F ]
        |
   [ RJ45 网口 ]
        |
   [ 网线 ]
        |
   [ 交换机 / 路由器 ]

```

## RK3588主板双网口带宽测试

### 外网口 eth1

**服务端  iperf3 -s**

```bash

lxg@lxg:~$ iperf3 -s
-----------------------------------------------------------
Server listening on 5201
-----------------------------------------------------------
Accepted connection from 192.168.0.127, port 46086
[  5] local 192.168.0.231 port 5201 connected to 192.168.0.127 port 46088
[ ID] Interval           Transfer     Bitrate
[  5]   0.00-1.00   sec   112 MBytes   940 Mbits/sec                  
[  5]   1.00-2.00   sec   112 MBytes   941 Mbits/sec                  
[  5]   2.00-3.00   sec   112 MBytes   941 Mbits/sec                  
[  5]   3.00-4.00   sec   112 MBytes   941 Mbits/sec                  
[  5]   4.00-5.00   sec   112 MBytes   941 Mbits/sec                  
[  5]   5.00-6.00   sec   112 MBytes   941 Mbits/sec                  
[  5]   6.00-7.00   sec   112 MBytes   941 Mbits/sec                  
[  5]   7.00-8.00   sec   112 MBytes   941 Mbits/sec                  
[  5]   8.00-9.00   sec   112 MBytes   941 Mbits/sec                  
[  5]   9.00-10.00  sec   112 MBytes   941 Mbits/sec                  
[  5]  10.00-10.00  sec   243 KBytes   926 Mbits/sec                  
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bitrate
[  5]   0.00-10.00  sec  1.10 GBytes   941 Mbits/sec                  receiver
-----------------------------------------------------------
Server listening on 5201
-----------------------------------------------------------
Accepted connection from 192.168.0.127, port 46090
[  5] local 192.168.0.231 port 5201 connected to 192.168.0.127 port 46092
[ ID] Interval           Transfer     Bitrate         Retr  Cwnd
[  5]   0.00-1.00   sec   114 MBytes   955 Mbits/sec    0    356 KBytes       
[  5]   1.00-2.00   sec   112 MBytes   939 Mbits/sec    0    376 KBytes       
[  5]   2.00-3.00   sec   113 MBytes   945 Mbits/sec    0    376 KBytes       
[  5]   3.00-4.00   sec   112 MBytes   939 Mbits/sec    0    376 KBytes       
[  5]   4.00-5.00   sec   113 MBytes   945 Mbits/sec    0    376 KBytes       
[  5]   5.00-6.00   sec   112 MBytes   939 Mbits/sec    0    376 KBytes       
[  5]   6.00-7.00   sec   112 MBytes   939 Mbits/sec    0    376 KBytes       
[  5]   7.00-8.00   sec   113 MBytes   945 Mbits/sec    0    376 KBytes       
[  5]   8.00-9.00   sec   112 MBytes   939 Mbits/sec    0    376 KBytes       
[  5]   9.00-10.00  sec   113 MBytes   950 Mbits/sec    0    549 KBytes       
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bitrate         Retr
[  5]   0.00-10.00  sec  1.10 GBytes   944 Mbits/sec    0             sender

```

**客户端**

iperf3 -c 192.168.0.231

iperf3 -c 192.168.0.231 -R

```bash

rk3588_s:/ $ iperf3 -c 192.168.0.231
Connecting to host 192.168.0.231, port 5201
[  5] local 192.168.0.127 port 46088 connected to 192.168.0.231 port 5201
[ ID] Interval           Transfer     Bitrate         Retr  Cwnd
[  5]   0.00-1.00   sec   113 MBytes   950 Mbits/sec    0    252 KBytes       
[  5]   1.00-2.00   sec   112 MBytes   942 Mbits/sec    0    252 KBytes       
[  5]   2.00-3.00   sec   112 MBytes   943 Mbits/sec    0    252 KBytes       
[  5]   3.00-4.00   sec   112 MBytes   942 Mbits/sec    0    252 KBytes       
[  5]   4.00-5.00   sec   112 MBytes   941 Mbits/sec    0    252 KBytes       
[  5]   5.00-6.00   sec   112 MBytes   941 Mbits/sec    0    252 KBytes       
[  5]   6.00-7.00   sec   112 MBytes   939 Mbits/sec    0    252 KBytes       
[  5]   7.00-8.00   sec   113 MBytes   945 Mbits/sec    0    252 KBytes       
[  5]   8.00-9.00   sec   112 MBytes   938 Mbits/sec    0    252 KBytes       
[  5]   9.00-10.00  sec   112 MBytes   943 Mbits/sec    0    252 KBytes       
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bitrate         Retr
[  5]   0.00-10.00  sec  1.10 GBytes   942 Mbits/sec    0             sender
[  5]   0.00-10.00  sec  1.10 GBytes   941 Mbits/sec                  receiver

iperf Done.
rk3588_s:/ $ iperf3 -c 192.168.0.231 -R                                                                                                                                                            
Connecting to host 192.168.0.231, port 5201
Reverse mode, remote host 192.168.0.231 is sending
[  5] local 192.168.0.127 port 46092 connected to 192.168.0.231 port 5201
[ ID] Interval           Transfer     Bitrate
[  5]   0.00-1.00   sec   112 MBytes   941 Mbits/sec                  
[  5]   1.00-2.00   sec   112 MBytes   942 Mbits/sec                  
[  5]   2.00-3.00   sec   112 MBytes   942 Mbits/sec                  
[  5]   3.00-4.00   sec   112 MBytes   942 Mbits/sec                  
[  5]   4.00-5.00   sec   112 MBytes   942 Mbits/sec                  
[  5]   5.00-6.00   sec   112 MBytes   941 Mbits/sec                  
[  5]   6.00-7.00   sec   112 MBytes   942 Mbits/sec                  
[  5]   7.00-8.00   sec   112 MBytes   941 Mbits/sec                  
[  5]   8.00-9.00   sec   112 MBytes   942 Mbits/sec                  
[  5]   9.00-10.00  sec   112 MBytes   942 Mbits/sec                  
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bitrate         Retr
[  5]   0.00-10.00  sec  1.10 GBytes   944 Mbits/sec    0             sender
[  5]   0.00-10.00  sec  1.10 GBytes   941 Mbits/sec                  receiver

iperf Done.

```

**测试报告**

| 测试方向       | 平均带宽       | 总传输数据量 | 测试时长 | 重传次数 |
|----------------|----------------|--------------|----------|----------|
| 上行（→ 主机） | 942 Mbits/sec  | 1.10 GBytes  | 10 秒    | 0 次     |
| 下行（← 主机） | 944 Mbits/sec  | 1.10 GBytes  | 10 秒    | 0 次     |

### 内网口 eth0

**海康相机可以打开的主板测试**

```bash

rk3588_s:/ $ iperf3 -c 192.168.0.231
Connecting to host 192.168.0.231, port 5201
[  5] local 192.168.0.125 port 51610 connected to 192.168.0.231 port 5201
[ ID] Interval           Transfer     Bitrate         Retr  Cwnd
[  5]   0.00-1.00   sec   114 MBytes   957 Mbits/sec    0    417 KBytes       
[  5]   1.00-2.00   sec   112 MBytes   937 Mbits/sec    0    417 KBytes       
[  5]   2.00-3.00   sec   113 MBytes   944 Mbits/sec    0    440 KBytes       
[  5]   3.00-4.00   sec   112 MBytes   944 Mbits/sec    0    440 KBytes       
[  5]   4.00-5.00   sec   112 MBytes   938 Mbits/sec    0    440 KBytes       
[  5]   5.00-6.00   sec   112 MBytes   943 Mbits/sec    0    461 KBytes       
[  5]   6.00-7.00   sec   112 MBytes   943 Mbits/sec    0    461 KBytes       
[  5]   7.00-8.00   sec   112 MBytes   937 Mbits/sec    0    461 KBytes       
[  5]   8.00-9.00   sec   112 MBytes   944 Mbits/sec    0    461 KBytes       
[  5]   9.00-10.00  sec   113 MBytes   945 Mbits/sec    0    461 KBytes       
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bitrate         Retr
[  5]   0.00-10.00  sec  1.10 GBytes   943 Mbits/sec    0             sender
[  5]   0.00-10.00  sec  1.10 GBytes   941 Mbits/sec                  receiver

iperf Done.
rk3588_s:/ $ iperf3 -c 192.168.0.231 -R
Connecting to host 192.168.0.231, port 5201
Reverse mode, remote host 192.168.0.231 is sending
[  5] local 192.168.0.125 port 51614 connected to 192.168.0.231 port 5201
[ ID] Interval           Transfer     Bitrate
[  5]   0.00-1.00   sec  4.55 MBytes  38.2 Mbits/sec                  
[  5]   1.00-2.00   sec  4.33 MBytes  36.3 Mbits/sec                  
[  5]   2.00-3.00   sec  3.83 MBytes  32.2 Mbits/sec                  
[  5]   3.00-4.00   sec  2.73 MBytes  22.9 Mbits/sec                  
[  5]   4.00-5.00   sec  0.00 Bytes  0.00 bits/sec                  
[  5]   5.00-6.00   sec  1.70 MBytes  14.3 Mbits/sec                  
[  5]   6.00-7.00   sec  3.94 MBytes  33.1 Mbits/sec                  
[  5]   7.00-8.00   sec  1.63 MBytes  13.7 Mbits/sec                  
[  5]   8.00-9.00   sec  8.02 MBytes  67.3 Mbits/sec                  
[  5]   9.00-10.00  sec  3.08 MBytes  25.8 Mbits/sec                  
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bitrate         Retr
[  5]   0.00-10.00  sec  33.9 MBytes  28.5 Mbits/sec  1209             sender
[  5]   0.00-10.00  sec  33.8 MBytes  28.4 Mbits/sec                  receiver

iperf Done.

```

**测试报告**

| 测试方向       | 平均带宽       | 总传输数据量 | 测试时长 | 重传次数 |
|----------------|----------------|--------------|----------|----------|
| 上行（→ 主机） | 943 Mbits/sec  | 1.10 GBytes  | 10 秒    | 0 次     |
| 下行（← 主机） | 28.5 Mbits/sec | 33.9 MBytes  | 10 秒    | 1209 次  |


**海康相机无法打开的主板测试**

```bash

rk3588_s:/ $ iperf3 -c 192.168.0.231
Connecting to host 192.168.0.231, port 5201
[  5] local 192.168.0.121 port 58756 connected to 192.168.0.231 port 5201
[ ID] Interval           Transfer     Bitrate         Retr  Cwnd
[  5]   0.00-1.00   sec   114 MBytes   954 Mbits/sec    0    460 KBytes       
[  5]   1.00-2.00   sec   112 MBytes   943 Mbits/sec    0    460 KBytes       
[  5]   2.00-3.00   sec   112 MBytes   943 Mbits/sec    0    460 KBytes       
[  5]   3.00-4.00   sec   112 MBytes   940 Mbits/sec    0    460 KBytes       
[  5]   4.00-5.00   sec   112 MBytes   938 Mbits/sec    0    460 KBytes       
[  5]   5.00-6.00   sec   112 MBytes   944 Mbits/sec    0    460 KBytes       
[  5]   6.00-7.00   sec   113 MBytes   944 Mbits/sec    0    460 KBytes       
[  5]   7.00-8.00   sec   112 MBytes   940 Mbits/sec    0    460 KBytes       
[  5]   8.00-9.00   sec   112 MBytes   943 Mbits/sec    0    460 KBytes       
[  5]   9.00-10.00  sec   112 MBytes   940 Mbits/sec    0    460 KBytes       
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bitrate         Retr
[  5]   0.00-10.00  sec  1.10 GBytes   943 Mbits/sec    0             sender
[  5]   0.00-10.00  sec  1.10 GBytes   941 Mbits/sec                  receiver

iperf Done.
rk3588_s:/ $ iperf3 -c 192.168.0.231 -R
Connecting to host 192.168.0.231, port 5201
Reverse mode, remote host 192.168.0.231 is sending
[  5] local 192.168.0.121 port 58760 connected to 192.168.0.231 port 5201
[ ID] Interval           Transfer     Bitrate
[  5]   0.00-1.00   sec   127 KBytes  1.04 Mbits/sec                  
[  5]   1.00-2.00   sec  84.8 KBytes   695 Kbits/sec                  
[  5]   2.00-3.00   sec  0.00 Bytes  0.00 bits/sec                  
[  5]   3.00-4.00   sec   216 KBytes  1.77 Mbits/sec                  
[  5]   4.00-5.00   sec  31.1 KBytes   255 Kbits/sec                  
[  5]   5.00-6.00   sec   103 KBytes   846 Kbits/sec                  
[  5]   6.00-7.00   sec  29.7 KBytes   243 Kbits/sec                  
[  5]   7.00-8.00   sec  0.00 Bytes  0.00 bits/sec                  
[  5]   8.00-9.00   sec   140 KBytes  1.15 Mbits/sec                  
[  5]   9.00-10.00  sec  0.00 Bytes  0.00 bits/sec                  
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bitrate         Retr
[  5]   0.00-10.00  sec   848 KBytes   695 Kbits/sec  139             sender
[  5]   0.00-10.00  sec   732 KBytes   600 Kbits/sec                  receiver

iperf Done.

```

**测试报告**

| 测试方向       | 平均带宽         | 总传输数据量 | 测试时长 | 重传次数 |
|----------------|------------------|--------------|----------|----------|
| 上行（→ 主机） | 943 Mbits/sec    | 1.10 GBytes  | 10 秒    | 0 次     |
| 下行（← 主机） | 695 Kbits/sec    | 848 KBytes   | 10 秒    | 139 次   |


## 问题网口驱动

```c

&gmac1 {
    phy-mode = "rgmii-rxid"; // SoC不加延迟，由PHY加
    clock_in_out = "output"; // SoC提供RGMII时钟

    snps,reset-gpio = <&gpio3 RK_PB7 GPIO_ACTIVE_LOW>;
    snps,reset-active-low;
    snps,reset-delays-us = <0 20000 100000>; // 拉低20ms，拉高后等待100ms

    pinctrl-names = "default";
    pinctrl-0 = <&gmac1_miim &gmac1_tx_bus2 &gmac1_rx_bus2 &gmac1_rgmii_clk &gmac1_rgmii_bus>;

    tx_delay = <0x43>;  // TX延迟（0x43 = 67）
    // rx_delay = <0x3f>;  // RX延迟注释掉了

    phy-handle = <&rgmii_phy>; // 指向 PHY 节点
    status = "okay";
};

```

**如何判断 RTL8211F 是 TXDLY/RXDLY 是否都关闭了**

看硬件电路图 / 查看芯片引脚状态（最准确）

| 引脚名 | 作用                        | 高电平（上拉） | 低电平（下拉） |
|--------|-----------------------------|----------------|----------------|
| TXDLY  | 是否启用 TX Delay (~2ns)   | ✅ 启用         | ❌ 禁用         |
| RXDLY  | 是否启用 RX Delay (~2ns)   | ✅ 启用         | ❌ 禁用         |

![rk3588_rtl8211f](/images/hardware/ethernet/rk3588_rtl8211f.png)

检查 TXDLY 和 RXDLY 是否接了 上拉电阻（如 10K 到 VCC） 或 下拉电阻（如 10K 到 GND）

```bash

TXDLY ---[10K]--- VCC     → 启用 TX Delay
RXDLY ---[10K]--- GND     → 禁用 RX Delay

```

![rk3588_rtl8211f_2](/images/hardware/ethernet/rk3588_rtl8211f_2.png)

从原理图上可以看到 TXDLY 禁用了， RXDLY 启用了, 所以理论上上述dts的驱动配置是正常的, 那为什么RX的带宽达不到要求呢？



















