---
layout:     post
title:      Android 流量统计
subtitle:   Traffic monitoring
date:       2024-03-29
author:     LXG
header-img: img/google_android.jpg
catalog: true
tags:
    - android
---

[eBPF 流量监控-AOSP](https://source.android.google.cn/devices/tech/datausage/ebpf-traffic-monitor?hl=zh-cn)

## Linux eBPF 技术

Linux中的eBPF（Extended Berkeley Packet Filter）是一种革命性的内核技术，它就像一个安全且高效的“小程序”引擎，允许开发者在不直接修改内核代码的情况下，在内核空间运行自己编写的程序。这些小程序可以在很多关键路径上运行，比如网络数据包处理、系统调用跟踪、性能分析，甚至是文件系统和安全策略执行等场景

## 调试命令

**adb shell dumpsys netd trafficcontroller**

```txt

lxg@lixiaogang:~$ adb shell dumpsys netd trafficcontroller

  TrafficController
    BPF module status: BPF_LEVEL_BASIC

    mCookieTagMap status: OK
    mUidCounterSetMap status: OK
    mAppUidStatsMap status: OK
    mStatsMapA status: OK
    mStatsMapB status: OK
    mIfaceIndexNameMap status: OK
    mIfaceStatsMap status: OK
    mConfigurationMap status: OK
    mUidOwnerMap status: OK

    Cgroup ingress program status: OK
    Cgroup egress program status: OK
    xt_bpf ingress program status: OK
    xt_bpf egress program status: OK
    xt_bpf bandwidth whitelist program status: OK
    xt_bpf bandwidth blacklist program status: OK

    BPF map content:

      mCookieTagMap:
      cookie=760 tag=0xfffffe03 uid=1000
      cookie=347 tag=0xfffffe02 uid=1000
      cookie=555 tag=0xfffffe02 uid=1000
      cookie=759 tag=0xfffffe02 uid=1000

      mUidCounterSetMap:
      1001 1
      10046 1
      10029 1
      10036 1

      mAppUidStatsMap::
      uid rxBytes rxPackets txBytes txPackets
      10046 54619 360 39385 401
      1051 1215 12 827 12
      0 0 0 14940 170
      10018 10383 14 1785 16
      1020 97099 351 57571 205
      1052 17859 139 17973 144
      1000 46792 199 28380 241

      mStatsMapA:
      ifaceIndex ifaceName tag_hex uid_int cnt_set rxBytes rxPackets txBytes txPackets
      10 usb0 0x0 10046 1 8493 47 7894 62
      10 usb0 0x0 10046 0 1993 25 2097 29
      14 wlan0 0x0 1052 0 4672 68 12775 68
      14 wlan0 0x0 1020 0 16820 64 6950 20
      14 wlan0 0xfffffe03 1000 0 656 2 676 2
      14 wlan0 0x0 0 0 0 0 368 3
      14 wlan0 0xfffffe02 1000 0 160 3 0 0
      10 usb0 0x0 1052 0 13187 71 5198 76
      10 usb0 0x0 1000 0 444 8 991 12
      10 usb0 0x0 1020 0 13872 40 6936 20
      10 usb0 0x0 1051 0 180 2 148 2
      10 usb0 0x0 0 0 0 0 1508 8
      14 wlan0 0x0 1000 0 816 5 676 2

      mStatsMapB:
      ifaceIndex ifaceName tag_hex uid_int cnt_set rxBytes rxPackets txBytes txPackets

      mIfaceIndexNameMap:
      ifaceIndex=8 ifaceName=sit0
      ifaceIndex=9 ifaceName=ip6tnl0
      ifaceIndex=6 ifaceName=ip_vti0
      ifaceIndex=7 ifaceName=ip6_vti0
      ifaceIndex=4 ifaceName=gre0
      ifaceIndex=2 ifaceName=eth0
      ifaceIndex=13 ifaceName=wlan0
      ifaceIndex=3 ifaceName=tunl0
      ifaceIndex=10 ifaceName=usb0
      ifaceIndex=5 ifaceName=gretap0
      ifaceIndex=14 ifaceName=wlan0
      ifaceIndex=1 ifaceName=lo
      ifaceIndex=12 ifaceName=wlan0

      mIfaceStatsMap::
      ifaceIndex ifaceName rxBytes rxPackets txBytes txPackets
      2 eth0 1345 7 3498 24
      13 wlan0 4432 14 10504 44
      10 usb0 476366 1759 495960 2198
      5 gretap0 0 0 384 4
      14 wlan0 358823 1204 343910 1104
      1 lo 4076 33 4076 33
      12 wlan0 8022 35 18872 106

      current ownerMatch configuration: 0
      current statsMap configuration: 0

      mUidOwnerMap:
      10006  HAPPY_BOX_MATCH

      mUidPermissionMap:
      10005 PERMISSION_NONE
      10035 PERMISSION_NONE
      1001  BPF_PERMISSION_INTERNET BPF_PERMISSION_UPDATE_DEVICE_STATS
      10003 PERMISSION_NONE
      10022 PERMISSION_NONE
      1073 PERMISSION_NONE
      10002 PERMISSION_NONE
      10034 PERMISSION_NONE
      10006  BPF_PERMISSION_INTERNET BPF_PERMISSION_UPDATE_DEVICE_STATS
      1002  BPF_PERMISSION_INTERNET BPF_PERMISSION_UPDATE_DEVICE_STATS
      10039 PERMISSION_NONE
      1003 PERMISSION_NONE
      10007 PERMISSION_NONE
      10045 PERMISSION_NONE
      10025 PERMISSION_NONE
      10014 PERMISSION_NONE
      10032 PERMISSION_NONE
      10020 PERMISSION_NONE
      10012 PERMISSION_NONE
      10024 PERMISSION_NONE
      10041 PERMISSION_NONE
      1041  BPF_PERMISSION_UPDATE_DEVICE_STATS
      10017 PERMISSION_NONE
      10033 PERMISSION_NONE
      1013  BPF_PERMISSION_INTERNET BPF_PERMISSION_UPDATE_DEVICE_STATS
      10010 PERMISSION_NONE
      10027 PERMISSION_NONE
      10011 PERMISSION_NONE
      10004 PERMISSION_NONE
      10037 PERMISSION_NONE
      10000 PERMISSION_NONE
      1047  BPF_PERMISSION_UPDATE_DEVICE_STATS
      1067 PERMISSION_NONE
      10038 PERMISSION_NONE
      10043 PERMISSION_NONE
      1066 PERMISSION_NONE
      10013 PERMISSION_NONE
      10036 PERMISSION_NONE
      1063 PERMISSION_NONE
      10019 PERMISSION_NONE
      10023 PERMISSION_NONE
      10001 PERMISSION_NONE

      mPrivilegedUser:
      1001 ALLOW_UPDATE_DEVICE_STATS
      1002 ALLOW_UPDATE_DEVICE_STATS
      1013 ALLOW_UPDATE_DEVICE_STATS
      1041 ALLOW_UPDATE_DEVICE_STATS
      1047 ALLOW_UPDATE_DEVICE_STATS
      10006 ALLOW_UPDATE_DEVICE_STATS


```

**adb shell dumpsys netstats --full --uid**

```txt

Active interfaces:
  iface=usb0 ident=[{type=MOBILE, subType=COMBINED, subscriberId=460086..., metered=true, defaultNetwork=true}] 
Active UID interfaces:
  iface=usb0 ident=[{type=MOBILE, subType=COMBINED, subscriberId=460086..., metered=true, defaultNetwork=true}] 
Top openSession callers (uid=count):

Dev stats:
  Pending bytes: 238053
  Complete history:
  ident=[{type=MOBILE, subType=COMBINED, subscriberId=460082..., metered=true, defaultNetwork=false}] uid=-1 set=ALL tag=0x0
    NetworkStatsHistory: bucketDuration=3600
      st=1711681200 rb=0 rp=0 tb=212 tp=3 op=0
  ident=[{type=MOBILE, subType=COMBINED, subscriberId=460082..., metered=true, defaultNetwork=true}] uid=-1 set=ALL tag=0x0
    NetworkStatsHistory: bucketDuration=3600
      st=1711681200 rb=59748425 rp=43312 tb=786425 tp=17976 op=0
  ident=[{type=MOBILE, subType=COMBINED, subscriberId=460086..., metered=true, defaultNetwork=true}] uid=-1 set=ALL tag=0x0
    NetworkStatsHistory: bucketDuration=3600
      st=1712026800 rb=125126 rp=587 tb=112927 tp=845 op=0
Xt stats:
  Pending bytes: 238053
  Complete history:
  ident=[{type=MOBILE, subType=COMBINED, subscriberId=460082..., metered=true, defaultNetwork=false}] uid=-1 set=ALL tag=0x0
    NetworkStatsHistory: bucketDuration=3600
      st=1711681200 rb=0 rp=0 tb=328 tp=5 op=0
  ident=[{type=MOBILE, subType=COMBINED, subscriberId=460082..., metered=true, defaultNetwork=true}] uid=-1 set=ALL tag=0x0
    NetworkStatsHistory: bucketDuration=3600
      st=1711681200 rb=59748425 rp=43312 tb=786425 tp=17976 op=0
  ident=[{type=MOBILE, subType=COMBINED, subscriberId=460086..., metered=true, defaultNetwork=true}] uid=-1 set=ALL tag=0x0
    NetworkStatsHistory: bucketDuration=3600
      st=1712026800 rb=125126 rp=587 tb=112927 tp=845 op=0
UID stats:
  Pending bytes: 221756
  Complete history:
  ident=[{type=MOBILE, subType=COMBINED, subscriberId=460082..., metered=true, defaultNetwork=false}] uid=0 set=DEFAULT tag=0x0
    NetworkStatsHistory: bucketDuration=7200
      st=1711677600 rb=0 rp=0 tb=376 tp=5 op=0
  ident=[{type=MOBILE, subType=COMBINED, subscriberId=460082..., metered=true, defaultNetwork=true}] uid=0 set=DEFAULT tag=0x0
    NetworkStatsHistory: bucketDuration=7200
      st=1711677600 rb=0 rp=0 tb=2453 tp=39 op=0
  ident=[{type=MOBILE, subType=COMBINED, subscriberId=460082..., metered=true, defaultNetwork=true}] uid=1000 set=DEFAULT tag=0x0
    NetworkStatsHistory: bucketDuration=7200
      st=1711677600 rb=59334215 rp=42639 tb=713280 tp=17139 op=0
  ident=[{type=MOBILE, subType=COMBINED, subscriberId=460082..., metered=true, defaultNetwork=true}] uid=1020 set=DEFAULT tag=0x0
    NetworkStatsHistory: bucketDuration=7200
      st=1711677600 rb=11798 rp=33 tb=7792 tp=22 op=0
  ident=[{type=MOBILE, subType=COMBINED, subscriberId=460082..., metered=true, defaultNetwork=true}] uid=1051 set=DEFAULT tag=0x0
    NetworkStatsHistory: bucketDuration=7200
      st=1711677600 rb=1692 rp=17 tb=1084 tp=17 op=0
  ident=[{type=MOBILE, subType=COMBINED, subscriberId=460082..., metered=true, defaultNetwork=true}] uid=10021 set=DEFAULT tag=0x0
    NetworkStatsHistory: bucketDuration=7200
      st=1711677600 rb=14889 rp=42 tb=12920 tp=156 op=0
  ident=[{type=MOBILE, subType=COMBINED, subscriberId=460082..., metered=true, defaultNetwork=true}] uid=10021 set=FOREGROUND tag=0x0
    NetworkStatsHistory: bucketDuration=7200
      st=1711677600 rb=163011 rp=132 tb=6382 tp=135 op=0
  ident=[{type=MOBILE, subType=COMBINED, subscriberId=460082..., metered=true, defaultNetwork=true}] uid=10046 set=DEFAULT tag=0x0
    NetworkStatsHistory: bucketDuration=7200
      st=1711677600 rb=36438 rp=269 tb=22295 tp=279 op=0
  ident=[{type=MOBILE, subType=COMBINED, subscriberId=460082..., metered=true, defaultNetwork=true}] uid=10046 set=FOREGROUND tag=0x0
    NetworkStatsHistory: bucketDuration=7200
      st=1711677600 rb=189046 rp=168 tb=12387 tp=166 op=0
  ident=[{type=MOBILE, subType=COMBINED, subscriberId=460086..., metered=true, defaultNetwork=true}] uid=0 set=DEFAULT tag=0x0
    NetworkStatsHistory: bucketDuration=7200
      st=1712023200 rb=0 rp=0 tb=5660 tp=76 op=0
  ident=[{type=MOBILE, subType=COMBINED, subscriberId=460086..., metered=true, defaultNetwork=true}] uid=1000 set=DEFAULT tag=0x0
    NetworkStatsHistory: bucketDuration=7200
      st=1712023200 rb=45532 rp=186 tb=26713 tp=227 op=0
  ident=[{type=MOBILE, subType=COMBINED, subscriberId=460086..., metered=true, defaultNetwork=true}] uid=1020 set=DEFAULT tag=0x0
    NetworkStatsHistory: bucketDuration=7200
      st=1712023200 rb=33160 rp=110 tb=23282 tp=78 op=0
  ident=[{type=MOBILE, subType=COMBINED, subscriberId=460086..., metered=true, defaultNetwork=true}] uid=1051 set=DEFAULT tag=0x0
    NetworkStatsHistory: bucketDuration=7200
      st=1712023200 rb=1035 rp=10 tb=679 tp=10 op=0
  ident=[{type=MOBILE, subType=COMBINED, subscriberId=460086..., metered=true, defaultNetwork=true}] uid=10018 set=DEFAULT tag=0x0
    NetworkStatsHistory: bucketDuration=7200
      st=1712023200 rb=3043 rp=4 tb=272 tp=5 op=0
  ident=[{type=MOBILE, subType=COMBINED, subscriberId=460086..., metered=true, defaultNetwork=true}] uid=10018 set=FOREGROUND tag=0x0
    NetworkStatsHistory: bucketDuration=7200
      st=1712023200 rb=7340 rp=10 tb=1513 tp=11 op=0
  ident=[{type=MOBILE, subType=COMBINED, subscriberId=460086..., metered=true, defaultNetwork=true}] uid=10046 set=DEFAULT tag=0x0
    NetworkStatsHistory: bucketDuration=7200
      st=1712023200 rb=7437 rp=26 tb=3073 tp=27 op=0
  ident=[{type=MOBILE, subType=COMBINED, subscriberId=460086..., metered=true, defaultNetwork=true}] uid=10046 set=FOREGROUND tag=0x0
    NetworkStatsHistory: bucketDuration=7200
      st=1712023200 rb=36696 rp=262 tb=26321 tp=283 op=0


```











