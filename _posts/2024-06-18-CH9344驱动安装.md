---
layout:     post
title:      CH9344 驱动安装
subtitle:   USB转多路485
date:       2024-06-18
author:     LXG
header-img: img/post-bg-xiaomi.jpg
catalog: true
tags:
    - ch348
---

[USB转8串口芯片 CH348](https://www.wch.cn/products/CH348.html)

## Linux 驱动

[CH9344SER_LINUX_ZIP](https://www.wch.cn/downloads/CH9344SER_LINUX_ZIP.html)

```txt

CH9344SER_LINUX/LINUX$ tree
.
├── demo
│   └── ch9344_demo_gpio.c
├── driver
│   ├── ch9344.c
│   ├── ch9344.h
│   └── Makefile
├── lib
│   ├── ch9344_lib.c
│   └── ch9344_lib.h
└── README.md

```

## Centos 7 驱动安装失败

```txt

[root@localhost driver]# make install
make -C /lib/modules/3.10.0-957.el7.x86_64/build  M=/root/LINUX/driver  
make[1]: 进入目录“/usr/src/kernels/3.10.0-1160.119.1.el7.x86_64”
  Building modules, stage 2.
  MODPOST 1 modules
make[1]: 离开目录“/usr/src/kernels/3.10.0-1160.119.1.el7.x86_64”
insmod ch9344.ko || true
insmod: ERROR: could not insert module ch9344.ko: Invalid parameters
mkdir -p /lib/modules/3.10.0-957.el7.x86_64/kernel/drivers/usb/serial/ || true
cp -f ./ch9344.ko /lib/modules/3.10.0-957.el7.x86_64/kernel/drivers/usb/serial/ || true
depmod -a
depmod: ERROR: fstatat(3, buildbak): No such file or directory

```

**问题原因: 当前系统内核版本和编译驱动使用的内核版本不一致导致**

* 当前运行的内核版本: 3.10.0-957.el7.x86_64
* 编译驱动使用的内核版本: 3.10.0-1160.119.1.el7.x86_64

```txt

[root@localhost lib]# rpm -qa | grep kernel
kernel-headers-3.10.0-1160.119.1.el7.x86_64
kernel-tools-3.10.0-957.el7.x86_64
kernel-3.10.0-957.el7.x86_64
kernel-devel-3.10.0-1160.119.1.el7.x86_64
abrt-addon-kerneloops-2.1.11-52.el7.centos.x86_64
kernel-tools-libs-3.10.0-957.el7.x86_64

```

**解决方案: 升级内核版本**

```txt

[root@localhost lib]# sudo yum update kernel
已加载插件：fastestmirror, langpacks
Loading mirror speeds from cached hostfile
 * base: mirrors.aliyun.com
 * centos-sclo-rh: mirrors.aliyun.com
 * centos-sclo-sclo: mirrors.aliyun.com
 * epel: mirrors.aliyun.com
 * extras: mirrors.aliyun.com
 * updates: mirrors.aliyun.com
正在解决依赖关系
--> 正在检查事务
---> 软件包 kernel.x86_64.0.3.10.0-1160.119.1.el7 将被 安装

```

**升级后命令查看内核版本**

```txt

[root@localhost ~]# rpm -qa | grep kernel
kernel-headers-3.10.0-1160.119.1.el7.x86_64
kernel-tools-3.10.0-957.el7.x86_64
kernel-3.10.0-1160.119.1.el7.x86_64
kernel-3.10.0-957.el7.x86_64
kernel-devel-3.10.0-1160.119.1.el7.x86_64
abrt-addon-kerneloops-2.1.11-52.el7.centos.x86_64
kernel-tools-libs-3.10.0-957.el7.x86_64


```

## 编译驱动并安装

```txt

[root@localhost driver]# make clean 
rm -rf *.mk .tmp_versions Module.symvers *.mod.c *.o *.ko .*.cmd Module.markers modules.order *.a *.mod

[root@localhost driver]# make 
make -C /lib/modules/3.10.0-1160.119.1.el7.x86_64/build  M=/root/LINUX/driver  
make[1]: 进入目录“/usr/src/kernels/3.10.0-1160.119.1.el7.x86_64”
  LD      /root/LINUX/driver/built-in.o
  CC [M]  /root/LINUX/driver/ch9344.o
  Building modules, stage 2.
  MODPOST 1 modules
  CC      /root/LINUX/driver/ch9344.mod.o
  LD [M]  /root/LINUX/driver/ch9344.ko
make[1]: 离开目录“/usr/src/kernels/3.10.0-1160.119.1.el7.x86_64”
[root@localhost driver]# make install
make -C /lib/modules/3.10.0-1160.119.1.el7.x86_64/build  M=/root/LINUX/driver  
make[1]: 进入目录“/usr/src/kernels/3.10.0-1160.119.1.el7.x86_64”
  Building modules, stage 2.
  MODPOST 1 modules
make[1]: 离开目录“/usr/src/kernels/3.10.0-1160.119.1.el7.x86_64”
insmod ch9344.ko || true
mkdir -p /lib/modules/3.10.0-1160.119.1.el7.x86_64/kernel/drivers/usb/serial/ || true
cp -f ./ch9344.ko /lib/modules/3.10.0-1160.119.1.el7.x86_64/kernel/drivers/usb/serial/ || true
depmod -a

[root@localhost ~]# ls /dev/ttyCH9344USB*
/dev/ttyCH9344USB0  /dev/ttyCH9344USB1  /dev/ttyCH9344USB2  /dev/ttyCH9344USB3  /dev/ttyCH9344USB4  /dev/ttyCH9344USB5  /dev/ttyCH9344USB6  /dev/ttyCH9344USB7

```

## 配置设备重启后驱动自动加载

sudo nano /etc/systemd/system/ch9344.service

```sh

[Unit]
Description=Load Ch9344 Kernel Module
After=local-fs.target

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/sbin/modprobe ch9344

[Install]
WantedBy=multi-user.target

```

sudo systemctl daemon-reload

sudo systemctl enable ch9344.service

```txt

[root@localhost modules]# sudo systemctl daemon-reload
[root@localhost modules]# sudo systemctl enable ch9344.service
Created symlink from /etc/systemd/system/multi-user.target.wants/ch9344.service to /etc/systemd/system/ch9344.service.

```
















