---
layout:     post
title:      T113-S3模拟成摄像头
subtitle:   USB Gadget
date:       2025-05-15
author:     LXG
header-img: img/post-bg-camera.jpg
catalog: true
tags:
    - linux
---

## 基本思路

**T113-S3 主板端（Device）充当 USB 设备**

* 启用 USB Device Controller（UDC）；
* 加载 g_webcam 模拟 UVC 摄像头；
* 将数据源（比如来自本地摄像头或文件）通过 v4l2loopback 注入；
* 最终通过 USB 提供视频数据给主机端（Host PC/Android 识别为摄像头设备）。

**安卓主机端（Host）识别为摄像头**

* 插上 USB 后自动识别为标准摄像头

## 简化后的流程图

```bash

T113-S3:
[Image Source] → /dev/video10 → v4l2loopback → /dev/video0 → g_webcam → USB Gadget

连接线:
T113 USB0 (OTG Device) <==> RK3568 USB-Host

RK3568:
通过 USB 识别为 UVC 摄像头 → /dev/videoX

```

## 确保 USB 接口支持 Device 模式

```bash

sh-4.4# ls /sys/class/udc/
4100000.udc-controller

```

## 配置内核（Buildroot + 外部内核）

```sh

CONFIG_USB_G_WEBCAM=y        # Gadget 摄像头支持
CONFIG_USB_LIBCOMPOSITE=y    # 必须支持 composite gadget 框架
CONFIG_USB_MUSB_HDRC=y       # 全志 USB 控制器
CONFIG_USB_MUSB_GADGET=y

```

以上配置后无法进入串口终端，修改成CONFIGFS方式

```sh

# CONFIG_USB_G_WEBCAM=y  不再需要
CONFIG_USB_CONFIGFS_F_UVC=y

```

## CONFIG_USB_G_WEBCAM=y 与 configfs 脚本方式对比

| 对比项 | 内核直接加载（g_webcam=y） | configfs 脚本加载（推荐） |
|--------|-----------------------------|----------------------------|
| 启动安全性 | ❌ 容易卡死串口/系统 | ✅ 启动后再加载，安全 |
| 串口可用性 | ❌ 可能导致 ttyS0 卡死或无输出 | ✅ 串口不会受影响 |
| 参数可调性（分辨率、描述符） | ❌ 固定参数 | ✅ 可自定义分辨率、帧率、VID/PID 等 |
| 视频源灵活性 | ❌ 默认由内核控制 | ✅ 可绑定任意 /dev/videoX |
| 热插拔支持 | ❌ 不支持热插拔 | ✅ 支持卸载/重新绑定 gadget |
| 复合设备支持（如串口+摄像头） | ❌ 需要重新编译 gadget 驱动 | ✅ 支持 gadget 多功能组合 |
| 调试友好程度 | ❌ 不利于调试 | ✅ 可随时启用/禁用，更灵活 |
| 适合阶段 | 开发初期测试用 | ✅ 推荐用于量产或高级定制场景 |

## configfs 配置 USB 摄像头 Gadget

```sh

#!/bin/bash
set -e

GADGET_DIR=/sys/kernel/config/usb_gadget/g1

mount -t configfs none /sys/kernel/config > /dev/null 2>&1

# 1. 创建 gadget 目录
mkdir -p $GADGET_DIR

# 2. 设置 USB设备ID和版本
echo 0x1d6b > $GADGET_DIR/idVendor    # Linux Foundation
echo 0x0104 > $GADGET_DIR/idProduct   # Multifunction Composite Gadget
echo 0x0100 > $GADGET_DIR/bcdDevice   # v1.0.0
echo 0x0200 > $GADGET_DIR/bcdUSB      # USB2

# 3. 创建字符串目录
mkdir -p $GADGET_DIR/strings/0x409
echo "0123456789" > $GADGET_DIR/strings/0x409/serialnumber
echo "MyManufacturer" > $GADGET_DIR/strings/0x409/manufacturer
echo "MyUSBWebcam" > $GADGET_DIR/strings/0x409/product

# 4. 创建配置
mkdir -p $GADGET_DIR/configs/c.1
echo 120 > $GADGET_DIR/configs/c.1/MaxPower  # 最大功率单位mA

# 配置描述字符串
mkdir -p $GADGET_DIR/configs/c.1/strings/0x409
echo "UVC Config" > $GADGET_DIR/configs/c.1/strings/0x409/configuration

# 5. 添加 UVC 功能
mkdir -p $GADGET_DIR/functions/uvc.usb0

# 可选：设置视频格式，分辨率，帧率
echo 307200 > $GADGET_DIR/functions/uvc.usb0/streaming_maxpacket  # 设置最大包大小

# 6. 绑定 UVC功能到配置
ln -s $GADGET_DIR/functions/uvc.usb0 $GADGET_DIR/configs/c.1/

# 7. 绑定到 UDC
# 查询设备支持的UDC驱动名
UDC=$(ls /sys/class/udc | head -n 1)

# 等待主机插入再绑定
while [ ! -e /sys/class/udc/$UDC ]; do
    echo "等待 UDC 出现..."
    sleep 1
done

echo $UDC > $GADGET_DIR/UDC

echo "USB Gadget 启动完成，设备上线"

```

## T113-S3 自带的/etc/adb_conf.sh与虚拟相机会冲突

**/etc/init.d/rcS**

```sh

/etc/adb_conf.sh start &

```

**adb_conf.sh**

```sh

#!/bin/sh

disable_udc="/etc/.disable_udc"
udc_config=/sys/kernel/config/usb_gadget/g1/UDC

function enable_udc(){
    while [ 1 ];do
        udc=`ls /sys/class/udc 2>/dev/null`
        isudc=`cat $udc_config 2>/dev/null`
        if [ "x$isudc" = "x" ] && [ -f $udc_config ]; then
            echo $udc > $udc_config
        fi
        sleep 1
        if [ -f $disable_udc ];then
            rm $disable_udc
            break
        fi
    done
}

function start_adb(){
    serialnumber=$1
    if [ "x$serialnumber" = "x" ];then
        serialnumber="0402101560"
    fi
    printf "Starting adb "
    # for adbd compatibilities
    mkdir -p /system/
    mkdir -p /system/bin
    if [ ! -f /system/bin/sh ];then
        ln -s /bin/sh /system/bin/sh
    fi

    # config ptmx
    mkdir -p /dev/pts
    mount -t devpts none /dev/pts

    # config adb function
    mount -t configfs none /sys/kernel/config > /dev/null 2>&1
    mkdir -p /sys/kernel/config/usb_gadget/g1
    echo "0x18d1" > /sys/kernel/config/usb_gadget/g1/idVendor
    echo "0x0002" > /sys/kernel/config/usb_gadget/g1/idProduct
    mkdir -p /sys/kernel/config/usb_gadget/g1/strings/0x409
    echo "$serialnumber" > /sys/kernel/config/usb_gadget/g1/strings/0x409/serialnumber
    echo "Google.Inc" > /sys/kernel/config/usb_gadget/g1/strings/0x409/manufacturer
    echo "Configfs ffs gadget" > /sys/kernel/config/usb_gadget/g1/strings/0x409/product
    mkdir -p /sys/kernel/config/usb_gadget/g1/functions/ffs.adb
    mkdir -p /sys/kernel/config/usb_gadget/g1/configs/c.1
    mkdir -p /sys/kernel/config/usb_gadget/g1/configs/c.1/strings/0x409
    echo 0xc0 > /sys/kernel/config/usb_gadget/g1/configs/c.1/bmAttributes
    echo 500 > /sys/kernel/config/usb_gadget/g1/configs/c.1/MaxPower
    ln -s /sys/kernel/config/usb_gadget/g1/functions/ffs.adb/ /sys/kernel/config/usb_gadget/g1/configs/c.1/ffs.adb > /dev/null 2>&1
    mkdir -p /dev/usb-ffs
    mkdir -p /dev/usb-ffs/adb
    if [ "x`ls -A /dev/usb-ffs/adb`" = "x" ];then
        mount -o uid=2000,gid=2000 -t functionfs adb /dev/usb-ffs/adb/
    fi

    # start adbd daemon
    adbd &
    sleep 1

    # enable udc
    #UDC_DEVICE=`find -name "usb_device"`
    #cat $UDC_DEVICE
    cat /sys/bus/platform/drivers/otg\ manager/soc\@3000000\:usbc0\@0/usb_device

    enable_udc &
}

case "$1" in
    start|"")
        otg_role_file="/sys/bus/platform/drivers/otg manager/usbc0/otg_role"
        [ -f "$otg_role_file" ] && otg_role=`cat "$otg_role_file"`
        if ifconfig > /dev/null 2>&1 && [ "x$otg_role" != "xusb_host" ];then
			autotest=/etc/.autotest
            [ -f $autotest ] && serialnumber=`cat $autotest`
	    if [ "x$serialnumber" = "x" ];then
		serialnumber=`cat /proc/cmdline | tr ' ' '\n' | grep 'snum' | awk -F "=" '{print $2}'`
	    fi
            start_adb $serialnumber
        fi
        ;;
    stop)
        printf "Stopping adbd "
        touch $disable_udc
		sleep 2
        killall adbd &
        [ $? -eq 0 ] && echo "OK" || "FAIL"
        ;;
    restart|reload)
        "$0" stop
        "$0" start
        ;;
    *)
        echo "Usage: $0 {start|stop|restart}"
        exit 1
        ;;
esac

```



























