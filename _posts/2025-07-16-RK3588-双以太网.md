---
layout:     post
title:      RK3588 双以太网
subtitle:   android 12
date:       2025-07-16
author:     LXG
header-img: img/post-bg-sky.jpg
catalog: true
tags:
    - rk3588
---

[rk-ethernet](https://github.com/Poco-Ye/rk-ethernet?search=1)

## 启动流程

#### 启动日志

```bash

2025-07-16 10:12:04.185   609-609   SystemServerTiming      system_server                        D  StartEthernet
2025-07-16 10:12:04.185   609-609   SystemServiceManager    system_server                        I  Starting com.android.server.ethernet.EthernetService
2025-07-16 10:12:04.185   609-609   EthernetService         system_server                        I  Registering service ethernet
2025-07-16 10:12:04.494   609-609   SystemServerTiming      system_server                        D  OnBootPhase_480_com.android.server.ethernet.EthernetService
2025-07-16 10:12:04.512   609-609   SystemServerTiming      system_server                        D  OnBootPhase_500_com.android.server.ethernet.EthernetService
2025-07-16 10:12:04.512   609-609   EthernetServiceImpl     system_server                        I  Starting Ethernet service
2025-07-16 10:12:04.513   609-609   EthernetTracker         system_server                        D  Interface match regexp set to 'eth1'
2025-07-16 10:12:04.514   609-609   Ethernet                system_server                        D  Registering NetworkFactory
2025-07-16 10:12:04.514   609-715   ConnectivityService     system_server                        D  Got NetworkProvider Messenger for Ethernet
2025-07-16 10:12:04.515   609-609   IpConfigStore           system_server                        E  Error opening configuration file: java.io.FileNotFoundException: /data/misc/ethernet/ipconfig.txt: open failed: ENOENT (No such file or directory)
2025-07-16 10:12:04.515   609-753   EthernetTracker         system_server                        I  maybeTrackInterface: eth1
2025-07-16 10:12:04.573   609-624   EthernetTracker         system_server                        I  interfaceLinkStateChanged, iface: eth1, up: false
2025-07-16 10:12:04.574   609-753   EthernetTracker         system_server                        D  Tracking interface in client mode: eth1
2025-07-16 10:12:04.574   609-753   EthernetNetworkFactory  system_server                        D  addInterface, iface: eth1, capabilities: [ Transports: ETHERNET Capabilities: NOT_METERED&INTERNET&NOT_RESTRICTED&TRUSTED&NOT_VPN&NOT_ROAMING&NOT_CONGESTED&NOT_SUSPENDED&NOT_VCN_MANAGED LinkUpBandwidth>=100000Kbps LinkDnBandwidth>=100000Kbps]
2025-07-16 10:12:04.574   609-753   EthernetNetworkFactory  system_server                        D  reconnecting Etherent
2025-07-16 10:12:04.574   609-753   EthernetNetworkFactory  system_server                        D  Starting Ethernet IpClient(eth1)
2025-07-16 10:12:04.603   609-609   SystemServerTiming      system_server                        D  OnBootPhase_520_com.android.server.ethernet.EthernetService
2025-07-16 10:12:04.825   609-609   SystemServerTiming      system_server                        D  OnBootPhase_550_com.android.server.ethernet.EthernetService
2025-07-16 10:12:04.926   609-609   SystemServerTiming      system_server                        D  OnBootPhase_600_com.android.server.ethernet.EthernetService
2025-07-16 10:12:04.956   609-609   SystemServerTiming      system_server                        D  ssm.onStartUser-0_com.android.server.ethernet.EthernetService
2025-07-16 10:12:05.790   609-753   EthernetNetworkFactory  system_server                        D  updateCapabilityFilter: [ Transports: ETHERNET Capabilities: NOT_METERED&INTERNET&NOT_RESTRICTED&TRUSTED&NOT_VPN&NOT_ROAMING&NOT_CONGESTED&NOT_SUSPENDED&NOT_VCN_MANAGED]
2025-07-16 10:12:05.790   609-753   EthernetNe...FactoryExt system_server                        E  get list of interfaces lo
2025-07-16 10:12:07.259   408-408   <no-tag>                netd                                 E  RTL8211F Gigabit Ethernet stmmac-1:01: 2ns TX delay was already disabled (by pin-strapping RXD1 or bootloader configuration)
2025-07-16 10:12:07.260   408-408   <no-tag>                netd                                 E  RTL8211F Gigabit Ethernet stmmac-1:01: Disabling 2ns RX delay (and changing the value from pin-strapping RXD0 or the bootloader)
2025-07-16 10:12:07.290   408-408   <no-tag>                netd                                 I  rk_gmac-dwmac fe1c0000.ethernet eth0: PHY [stmmac-1:01] driver [RTL8211F Gigabit Ethernet] (irq=POLL)
2025-07-16 10:12:07.293   408-408   <no-tag>                netd                                 I  rk_gmac-dwmac fe1c0000.ethernet eth0: No Safety Features support found
2025-07-16 10:12:07.293   408-408   <no-tag>                netd                                 I  rk_gmac-dwmac fe1c0000.ethernet eth0: IEEE 1588-2008 Advanced Timestamp supported
2025-07-16 10:12:07.293   408-408   <no-tag>                netd                                 I  rk_gmac-dwmac fe1c0000.ethernet eth0: registered PTP clock
2025-07-16 10:12:07.294   408-408   <no-tag>                netd                                 I  rk_gmac-dwmac fe1c0000.ethernet eth0: configuring for phy/rgmii link mode
2025-07-16 10:12:05.854   609-624   EthernetTracker         system_server                        I  interfaceLinkStateChanged, iface: eth0, up: false
2025-07-16 10:12:05.854   609-624   EthernetTracker         system_server                        I  interfaceLinkStateChanged, iface: eth0, up: false
2025-07-16 10:12:05.854   609-753   EthernetNetworkFactory  system_server                        D  updateInterfaceLinkState, iface: eth1, up: false
2025-07-16 10:12:05.854   609-753   EthernetNe...FactoryExt system_server                        D  interfaceLinkStateChanged: iface = eth1, mIface = eth0,up:false,mLinkUp:false
2025-07-16 10:12:05.854   609-753   EthernetNe...FactoryExt system_server                        D  interfaceLinkStateChanged: iface = eth0, mIface = eth0,up:false,mLinkUp:false
2025-07-16 10:12:05.854   609-753   EthernetNe...FactoryExt system_server                        D  interfaceLinkStateChanged: iface = eth0, mIface = eth0,up:false,mLinkUp:false

# 外网接入
2025-07-16 10:12:08.854   609-1201  EthernetTracker         system_server                        D  eth1 isEthernetInterfaceActive = true
2025-07-16 10:12:15.723   609-624   EthernetTracker         system_server                        I  interfaceLinkStateChanged, iface: eth1, up: true
2025-07-16 10:12:15.724   609-753   EthernetNetworkFactory  system_server                        D  updateInterfaceLinkState, iface: eth1, up: true
2025-07-16 10:12:15.793   609-753   EthernetNetworkFactory  system_server                        D  Starting Ethernet IpClient(eth1)
2025-07-16 10:12:15.794   609-753   EthernetNe...FactoryExt system_server                        D  interfaceLinkStateChanged: iface = eth1, mIface = eth0,up:true,mLinkUp:false

2025-07-16 10:12:16.318   609-753   ConnectivityService     system_server                        D  registerNetworkAgent NetworkAgentInfo{network{100}  handle{432902426637}  ni{Ethernet CONNECTING extra: 3a:97:4c:27:bb:ee} Score(70 ; KeepConnected : 0 ; Policies : IS_UNMETERED)   lp{{InterfaceName: eth1 LinkAddresses: [ fe80::d3:28:27a5:9920/64,192.168.1.183/24 ] DnsAddresses: [ /192.168.1.1 ] Domains: null MTU: 0 ServerAddress: /192.168.1.1 TcpBufferSizes: 524288,1048576,3145728,524288,1048576,2097152 Routes: [ fe80::/64 -> :: eth1 mtu 0,192.168.1.0/24 -> 0.0.0.0 eth1 mtu 0,0.0.0.0/0 -> 192.168.1.1 eth1 mtu 0 ]}}  nc{[ Transports: ETHERNET Capabilities: NOT_METERED&INTERNET&NOT_RESTRICTED&TRUSTED&NOT_VPN&NOT_ROAMING&FOREGROUND&NOT_CONGESTED&NOT_SUSPENDED&NOT_VCN_MANAGED LinkUpBandwidth>=100000Kbps LinkDnBandwidth>=100000Kbps]}}

2025-07-16 10:12:16.322   609-715   ConnectivityService     system_server                        D  [100 ETHERNET] EVENT_NETWORK_INFO_CHANGED, going from CONNECTING to CONNECTING
2025-07-16 10:12:16.322   609-715   ConnectivityService     system_server                        D  [100 ETHERNET] EVENT_NETWORK_INFO_CHANGED, going from CONNECTING to CONNECTED
2025-07-16 10:12:16.383   609-715   ConnectivityService     system_server                        D  Switching to new default network for: uid/pid:1000/609 activeRequest: 1 callbackRequest: 1 [NetworkRequest [ REQUEST id=1, [ Capabilities: INTERNET&NOT_RESTRICTED&TRUSTED&NOT_VPN&NOT_VCN_MANAGED RequestorUid: 1000 RequestorPkg: android] ]] callback flags: 1 priority: 2147483647 using NetworkAgentInfo{network{100}  handle{432902426637}  ni{Ethernet CONNECTED extra: 3a:97:4c:27:bb:ee} Score(70 ; KeepConnected : 0 ; Policies : IS_UNMETERED)   lp{{InterfaceName: eth1 LinkAddresses: [ fe80::d3:28:27a5:9920/64,192.168.1.183/24 ] DnsAddresses: [ /192.168.1.1 ] Domains: null MTU: 0 ServerAddress: /192.168.1.1 TcpBufferSizes: 524288,1048576,3145728,524288,1048576,2097152 Routes: [ fe80::/64 -> :: eth1 mtu 0,192.168.1.0/24 -> 0.0.0.0 eth1 mtu 0,0.0.0.0/0 -> 192.168.1.1 eth1 mtu 0 ]}}  nc{[ Transports: ETHERNET Capabilities: NOT_METERED&INTERNET&NOT_RESTRICTED&TRUSTED&NOT_VPN&NOT_ROAMING&FOREGROUND&NOT_CONGESTED&NOT_SUSPENDED&NOT_VCN_MANAGED LinkUpBandwidth>=100000Kbps LinkDnBandwidth>=100000Kbps]}}
2025-07-16 10:12:16.409   609-715   ConnectivityService     system_server                        D  Sending CONNECTED broadcast for type 9 [100 ETHERNET] isDefaultNetwork=true
2025-07-16 10:12:16.415   609-715   ConnectivityService     system_server                        D  [100 ETHERNET] validation passed

# 内网接入
2025-07-16 10:22:33.060   609-624   EthernetTracker         system_server                        I  interfaceLinkStateChanged, iface: eth0, up: true
2025-07-16 10:22:33.060   609-753   EthernetNe...FactoryExt system_server                        D  interfaceLinkStateChanged: iface = eth0, mIface = eth0,up:true,mLinkUp:false
2025-07-16 10:22:34.526   218-218   <no-tag>                kworker/3                            I  rk_gmac-dwmac fe1c0000.ethernet eth0: Link is Up - 100Mbps/Full - flow control off
2025-07-16 10:22:34.061   609-2127  EthernetNe...FactoryExt system_server                        D  IpClient.startProvisioning
2025-07-16 10:22:34.062   609-2127  EthernetNe...FactoryExt system_server                        D  startDhcp success for eth0
2025-07-16 10:22:34.068   609-2128  EthernetNe...FactoryExt system_server                        D  onLinkPropertiesChange

```

#### SystemServer.java

./java/com/android/server/SystemServer.java

```java

    private void startOtherServices(@NonNull TimingsTraceAndSlog t) {

            if (mPackageManager.hasSystemFeature(PackageManager.FEATURE_ETHERNET) ||
                    mPackageManager.hasSystemFeature(PackageManager.FEATURE_USB_HOST)) {
                t.traceBegin("StartEthernet");
                mSystemServiceManager.startService(ETHERNET_SERVICE_CLASS);
                t.traceEnd();
            }

    }

```

#### EthernetService.java

./opt/net/ethernet/java/com/android/server/ethernet/EthernetService.java


```java

public final class EthernetService extends SystemService {

    private static final String TAG = "EthernetService";
    final EthernetServiceImpl mImpl;

    public EthernetService(Context context) {
        super(context);
        mImpl = new EthernetServiceImpl(context);
    }

    @Override
    public void onStart() {
        Log.i(TAG, "Registering service " + Context.ETHERNET_SERVICE);
        publishBinderService(Context.ETHERNET_SERVICE, mImpl);
    }

    @Override
    public void onBootPhase(int phase) {
        if (phase == SystemService.PHASE_SYSTEM_SERVICES_READY) {
            mImpl.start();
        }
    }
}

```

#### EthernetServiceImpl.java

./opt/net/ethernet/java/com/android/server/ethernet/EthernetServiceImpl.java

```java


public class EthernetServiceImpl extends IEthernetManager.Stub {

    public void start() {
        Log.i(TAG, "Starting Ethernet service");

        HandlerThread handlerThread = new HandlerThread("EthernetServiceThread");
        handlerThread.start();
        mHandler = new Handler(handlerThread.getLooper());

        mTracker = new EthernetTracker(mContext, mHandler);
        mTracker.start();

        mStarted.set(true);
    }

}

```

#### EthernetTracker.java

./opt/net/ethernet/java/com/android/server/ethernet/EthernetTracker.java

```java

final class EthernetTracker {


    //lixiaogang add
    private EthernetNetworkFactoryExt mEthernetNetworkFactoryExt;

    EthernetTracker(Context context, Handler handler) {
        mContext = context;
        mHandler = handler;

        // The services we use.
        IBinder b = ServiceManager.getService(Context.NETWORKMANAGEMENT_SERVICE);
        mNMService = INetworkManagementService.Stub.asInterface(b);
        mNetd = Objects.requireNonNull(NetdService.getInstance(), "could not get netd instance");

        // Interface match regex.
        updateIfaceMatchRegexp();

        // Read default Ethernet interface configuration from resources
        final String[] interfaceConfigs = context.getResources().getStringArray(
                com.android.internal.R.array.config_ethernet_interfaces);
        for (String strConfig : interfaceConfigs) {
            parseEthernetConfig(strConfig);
        }

        mConfigStore = new EthernetConfigStore();

        NetworkCapabilities nc = createNetworkCapabilities(true /* clear default capabilities */);
        mFactory = new EthernetNetworkFactory(handler, context, nc);
        mFactory.register();
        mWifiSleepController = new WifiSleepController(mContext);

        //lixiaogang add
        mEthernetNetworkFactoryExt = new EthernetNetworkFactoryExt();
    }

}

```

























