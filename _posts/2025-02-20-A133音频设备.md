---
layout:     post
title:      A133 音频设备
subtitle:   android 10
date:       2025-02-25
author:     LXG
header-img: img/post-bg-smart_phone.jpg
catalog: true
tags:
    - audio
---

[音频-AOSP](https://source.android.google.cn/docs/core/audio?hl=zh-cn)

[Android Framework 音频子系统（02）音频系统框架](https://blog.csdn.net/vviccc/article/details/105265359)

## AOSP 音频架构

![ape_fwk_audio](/images/android/audio/ape_fwk_audio.png)

## 查看音频硬件命令

```bash

WIFBY:/ $ cat proc/asound/cards                                                                                                                                                                    
 0 [sun50iw10codec ]: sun50iw10-codec - sun50iw10-codec
                      sun50iw10-codec
 1 [CAMERA         ]: USB-Audio - WN Full HD CAMERA
                      WN-ZW-220419 WN Full HD CAMERA at usb-sunxi-ehci-1.2, high speed

```

| 设备索引 | 设备名称               | 设备类型          | 连接方式              | 备注                     |
|---------|----------------------|---------------|-----------------|----------------------|
| 0       | sun50iw10-codec      | 板载音频设备      | SoC 内置            | 可能是扬声器或 3.5mm 接口 |
| 1       | WN Full HD CAMERA    | USB 音频设备      | USB（usb-sunxi-ehci-1.2） | 摄像头自带麦克风        |

## A133 音频框架

![a133_audio](/images/android/audio/a133_audio.png)

在 A133 中，存在 7 个音频设备，分别是：

![a133_audio_hardware](/images/android/audio/a133_audio_hardware.png)

## Linux ALSA

ALSA（Advanced Linux Sound Architecture，高级 Linux 声音架构） 是 Linux 内核中的一套音频驱动框架，用于管理音频设备（声卡、麦克风、USB 音频设备等

ASoC（ALSA System on Chip） 是 ALSA（Linux 声音架构）专门为 SoC 设计的音频子系统，用于管理嵌入式系统（如开发板、智能设备）上的音频设备。

**🔹 为什么需要 ASoC？**

普通 PC 的声卡一般是**标准化的**（如 Intel HDA、USB 声卡），ALSA 可以直接支持。但嵌入式系统的音频硬件**千差万别**，需要更灵活的架构来管理。因此，ASoC 主要解决以下问题：

1. **不同 SoC 芯片的音频控制逻辑不同**（如 Allwinner、Rockchip、Qualcomm、Amlogic）
2. **音频编解码器（Codec）种类繁多**（不同厂商使用不同的 DAC/ADC 芯片）
3. **开发板的音频架构复杂**（可能有多个 I2S 接口、多个音频通路）
4. **降低驱动代码重复**，方便移植和维护


**🔹 ASoC 结构**
ASoC 把 SoC 的音频系统拆分成**三大部分**，这样更易于适配不同硬件：

| 组件 | 作用 | 例子 |
|------|------|------|
| **Codec 驱动** | 负责管理 **音频编解码芯片**（DAC/ADC） | WM8960、ES8316、RT5645 |
| **Platform 驱动** | 负责 SoC 的 **I2S、DMA 传输** | Allwinner ASoC、Rockchip I2S |
| **Machine 驱动** | 把 **Codec 和 Platform 连接起来**，定义音频路由 | 开发板的音频拓扑，比如扬声器连哪个接口 |


## A133 音频接口对比

| **接口**        | **用途**                | **特点**                                      | **适用场景**                     |
|----------------|------------------------|----------------------------------------------|----------------------------------|
| **I2S**       | 外部 Codec / DSP       | 支持 **192kHz 采样率、TDM、多通道传输**     | **高质量音频播放、HiFi 设备**    |
| **PCM**       | 语音通讯               | 兼容 **VoIP / 蓝牙语音**，支持短帧/长帧模式 | **蓝牙音频、对讲系统**          |
| **DMIC**      | 数字麦克风接口         | **双通道 PDM**，直连 MEMS 数字麦克风       | **AI 语音助手、降噪拾音**        |
| **AUDIO CODEC** | 内部音频编解码器       | 内置 **DAC/ADC**，直驱耳机/扬声器          | **基础音频播放、录音**           |

## 音频系统底层设备节点

```bash

WIFBY:/ $ ls dev/snd/
controlC0 controlC1 pcmC0D0c pcmC0D0p pcmC1D0c timer

WIFBY:/ $ cat /proc/asound/pcm
00-00: SUNXI-CODEC sun50iw10codec-0 :  : playback 1 : capture 1
01-00: USB Audio : USB Audio : capture 1

```

| **设备文件**  | **含义** |
|--------------|---------|
| `controlC0`  | **控制设备 0**（用于控制音频设备，如 mixer 设置） |
| `controlC1`  | **控制设备 1**（如果有多个声卡，每个声卡有自己的 control 设备） |
| `pcmC0D0c`   | **PCM 设备（Card 0, Device 0, Capture）**，表示**音频输入（录音）** |
| `pcmC0D0p`   | **PCM 设备（Card 0, Device 0, Playback）**，表示**音频输出（播放）** |
| `pcmC1D0c`   | **PCM 设备（Card 1, Device 0, Capture）**，表示**第二张声卡的录音设备** |
| `timer`      | **音频时间同步相关设备** |


## dumpsys media.audio_policy

RK3568识别到了USB-Audio - WN Full HD CAMERA

全志A133没有识别到

```txt
- Available input devices:
  Device 3:
  - id:  9
  - tag name: USB-Audio - WN Full HD CAMERA
  - type: AUDIO_DEVICE_IN_USB_DEVICE                      
  - supported encapsulation modes: 0  - supported encapsulation metadata types: 0  - address: card=2;device=0;                
  - name: USB-Audio - WN Full HD CAMERA
  - Profiles:
      Profile 0:[dynamic format]
          - format: AUDIO_FORMAT_PCM_16_BIT
          - sampling rates:8000, 16000, 44100, 48000
          - channel masks:0x000c, 0x0010, 0x80000001
  Device 4:
  - id:  6
  - tag name: Built-In Mic
  - type: AUDIO_DEVICE_IN_BUILTIN_MIC                     
  - supported encapsulation modes: 0  - supported encapsulation metadata types: 0  - address: bottom                          
  - Profiles:
      Profile 0:[dynamic format][dynamic channels][dynamic rates]
      Profile 1:
          - format: AUDIO_FORMAT_PCM_16_BIT
          - sampling rates:8000, 11025, 12000, 16000, 22050, 24000, 32000, 44100, 48000
          - channel masks:0x000c, 0x0010

```

## 分析

frameworks/av/services/audiopolicy/managerdefault/AudioPolicyManager.cpp

```cpp


AudioPolicyManager::AudioPolicyManager(AudioPolicyClientInterface *clientInterface)
        : AudioPolicyManager(clientInterface, false /*forTesting*/)
{
    loadConfig();
    initialize();
}


void AudioPolicyManager::loadConfig() {
    if (deserializeAudioPolicyXmlConfig(getConfig()) != NO_ERROR) {
        ALOGE("could not load audio policy configuration file, setting defaults");
        getConfig().setDefault();
    }
}

status_t AudioPolicyManager::initialize() {
     // -----------------------------------------

    // mAvailableOutputDevices and mAvailableInputDevices now contain all attached devices
    // open all output streams needed to access attached devices
    for (const auto& hwModule : mHwModulesAll) {
        ALOGI("Processing hardware module: %s", hwModule->getName());  // 打印正在处理的硬件模块名称

        // 打印当前硬件模块的可用输出和输入设备信息
        ALOGI("Available input devices for module %s: %s", hwModule->getName(), mAvailableInputDevices.toString().c_str());
        ALOGI("Available output devices for module %s: %s", hwModule->getName(), mAvailableOutputDevices.toString().c_str());

        hwModule->setHandle(mpClientInterface->loadHwModule(hwModule->getName()));
        if (hwModule->getHandle() == AUDIO_MODULE_HANDLE_NONE) {
            ALOGW("could not open HW module %s", hwModule->getName());
            continue;
        }
        mHwModules.push_back(hwModule);
        // open all output streams needed to access attached devices
        // except for direct output streams that are only opened when they are actually
        // required by an app.
        // This also validates mAvailableOutputDevices list
        for (const auto& outProfile : hwModule->getOutputProfiles()) {
             //--------------------------------------------
        }
        // open input streams needed to access attached devices to validate
        // mAvailableInputDevices list
        for (const auto& inProfile : hwModule->getInputProfiles()) {
            if (!inProfile->canOpenNewIo()) {
                ALOGE("Invalid Input profile max open count %u for profile %s",
                      inProfile->maxOpenCount, inProfile->getTagName().c_str());
                continue;
            }
            if (!inProfile->hasSupportedDevices()) {
                ALOGW("Input profile contains no device on module %s", hwModule->getName());
                continue;
            }
            // chose first device present in profile's SupportedDevices also part of
            // available input devices
            const DeviceVector &supportedDevices = inProfile->getSupportedDevices();

            ALOGI("Supported devices for profile %s: %s", inProfile->getTagName().c_str(), supportedDevices.toString().c_str());
            DeviceVector availProfileDevices = supportedDevices.filter(mAvailableInputDevices);
            // 打印筛选后的可用设备列表
            ALOGI("Available input devices after filter: %s", availProfileDevices.toString().c_str());
            if (availProfileDevices.isEmpty()) {
                ALOGE("%s: Input device list is empty!", __FUNCTION__);
                continue;
            }

            // --------------------------------------------------
        }
    }

    //----------------------------------------------------------

}

```

**日志打印**

```txt


// 在 Android 音频系统中，primary 是主要的音频硬件模块，负责处理 主声卡（main sound card） 的音频输入/输出。
APM_AudioPolicyManager  pid-2137                             I  Processing hardware module: primary
APM_AudioPolicyManager  pid-2137                             I  Available input devices for module primary: {type:0x80000004,@:;type:0x80000100,@:0}
APM_AudioPolicyManager  pid-2137                             I  Available output devices for module primary: {type:0x2,@:}
APM_AudioPolicyManager  pid-2137                             I  Supported devices for profile primary input: {type:0x80000004,@:;type:0x80000010,@:;type:0x80000008,@:}
APM_AudioPolicyManager  pid-2137                             I  Available input devices after filter: {type:0x80000004,@:}
APM_AudioPolicyManager  pid-2137                             W  Input profile contains no device on module primary

// A2DP（Advanced Audio Distribution Profile）是 蓝牙音频传输协议，用于 蓝牙音箱、耳机、车载音响等音频输出设备。
APM_AudioPolicyManager  pid-2137                             I  Processing hardware module: a2dp
APM_AudioPolicyManager  pid-2137                             I  Available input devices for module a2dp: {type:0x80000004,@:;type:0x80000100,@:0}
APM_AudioPolicyManager  pid-2137                             I  Available output devices for module a2dp: {type:0x2,@:}
APM_AudioPolicyManager  pid-2137                             I  Supported devices for profile a2dp input: {type:0x80020000,@:}
APM_AudioPolicyManager  pid-2137                             I  Available input devices after filter: AUDIO_DEVICE_NONE
APM_AudioPolicyManager  pid-2137                             E  initialize: Input device list is empty!



APM_AudioPolicyManager  pid-2137                             I  Processing hardware module: usb
APM_AudioPolicyManager  pid-2137                             I  Available input devices for module usb: {type:0x80000004,@:;type:0x80000100,@:0}
APM_AudioPolicyManager  pid-2137                             I  Available output devices for module usb: {type:0x2,@:}
APM_AudioPolicyManager  pid-2137                             I  Supported devices for profile usb_device input: {type:0x80001000,@:;type:0x82000000,@:}
APM_AudioPolicyManager  pid-2137                             I  Available input devices after filter: AUDIO_DEVICE_NONE
APM_AudioPolicyManager  pid-2137                             E  initialize: Input device list is empty!


// r_submix（Remote Submix）是 Android 的 虚拟音频设备
APM_AudioPolicyManager  pid-2137                             I  Processing hardware module: r_submix
APM_AudioPolicyManager  pid-2137                             I  Available input devices for module r_submix: {type:0x80000004,@:;type:0x80000100,@:0}
APM_AudioPolicyManager  pid-2137                             I  Available output devices for module r_submix: {type:0x2,@:}
APM_AudioPolicyManager  pid-2137                             I  Supported devices for profile r_submix input: {type:0x80000100,@:0}
APM_AudioPolicyManager  pid-2137                             I  Available input devices after filter: {type:0x80000100,@:0}


```

**设备类型定义**

./system/media/audio/include/system/audio-base.h

```c

enum {

    AUDIO_DEVICE_IN_BUILTIN_MIC                = 0x80000004u, // BIT_IN | 0x4
    AUDIO_DEVICE_IN_BLUETOOTH_SCO_HEADSET      = 0x80000008u, // BIT_IN | 0x8
    AUDIO_DEVICE_IN_WIRED_HEADSET              = 0x80000010u, // BIT_IN | 0x10
    AUDIO_DEVICE_IN_REMOTE_SUBMIX              = 0x80000100u, // BIT_IN | 0x100
    AUDIO_DEVICE_IN_USB_DEVICE                 = 0x80001000u, // BIT_IN | 0x1000
}

```

**分析**

未识别到 AUDIO_DEVICE_IN_USB_DEVICE(0x80001000u) 设备


















