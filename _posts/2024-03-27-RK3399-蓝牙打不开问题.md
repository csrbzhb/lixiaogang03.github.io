---
layout:     post
title:      RK3399 蓝牙打不开问题
subtitle:   rk3399 android 11
date:       2024-03-27
author:     LXG
header-img: img/post-bg-android.jpg
catalog: true
tags:
    - rk3399
---

## 问题日志

```txt

2024-03-26 18:48:52.060  2013-2042  bt_btif_storage         pid-2013                             E  btif_storage_get_adapter_property: Controller not ready! Unable to return Bluetooth Address
2024-03-26 18:48:52.060  2013-2042  BluetoothServiceJni     pid-2013                             E  adapter_properties_callback: Status 1 is incorrect
2024-03-26 18:48:52.183   276-300   android.ha....0-service and...ardware.bluetooth@1.0-service  E  vendor storage read success
2024-03-26 18:48:52.183   276-300   android.ha....0-service and...ardware.bluetooth@1.0-service  E  Got local bdaddr for vendor storage 22:22:D1:CC:6E:CF
2024-03-26 18:48:52.184   276-300   bt_h5_int               and...ardware.bluetooth@1.0-service  E  OsAllocateTimer rtk_parse sigev.sigev_notify_thread_id = syscall(__NR_gettid)!
2024-03-26 18:48:52.185   276-300   bt_h5_int               and...ardware.bluetooth@1.0-service  E  OsAllocateTimer rtk_parse sigev.sigev_notify_thread_id = syscall(__NR_gettid)!
2024-03-26 18:48:52.186   276-300   libbt_vendor            and...ardware.bluetooth@1.0-service  E  bt_wake_up_host_mode_set(1)
2024-03-26 18:48:52.186   276-300   bt_upio                 and...ardware.bluetooth@1.0-service  E  bt_wake_up_host_mode_set
2024-03-26 18:48:52.186   276-300   bt_upio                 and...ardware.bluetooth@1.0-service  E  bt_wake_up_host_mode_set path:/proc/bluetooth/sleep/lpm
2024-03-26 18:48:52.186   276-300   bt_upio                 and...ardware.bluetooth@1.0-service  E  bt_wake_up_host_mode_set fd:8 = open(path, O_RDWR): open(/proc/bluetooth/sleep/lpm) success
2024-03-26 18:48:52.186   276-300   bt_upio                 and...ardware.bluetooth@1.0-service  E  bt_wake_up_host_mode_set buffer:49
2024-03-26 18:48:52.186   276-300   libbt_vendor            and...ardware.bluetooth@1.0-service  E  rtk_btsnoop_dump = 0, rtk_btsnoop_save_log = 0
2024-03-26 18:48:56.262   276-2076  bt_hwcfg_uart           and...ardware.bluetooth@1.0-service  E  hw_config_cback, status = 3
--------- beginning of crash
2024-03-26 18:48:56.282  2013-2057  droid.bluetoot          com.android.bluetooth                A  [0326/184856.263475:FATAL:hci_layer_android.cc(102)] Check failed: status == Status::SUCCESS. 
                                                                                                    #00 0x00000076ecbf938f /system/lib64/libchrome.so+0x00000000000b738f
                                                                                                    #01 0x00000076ec54fd8b /system/lib64/libbluetooth.so+0x00000000002cfd8b
                                                                                                    #02 0x00000076ec9ed57b /system/lib64/android.hardware.bluetooth@1.0.so+0x000000000001b57b
                                                                                                    #03 0x00000076ec9aec3b /system/lib64/android.hardware.bluetooth@1.1.so+0x000000000001bc3b
                                                                                                    #04 0x00000079e5e9889b /system/lib64/libhidlbase.so+0x000000000009489b
                                                                                                    #05 0x00000079e5e9c94f /system/lib64/libhidlbase.so+0x000000000009894f
                                                                                                    #06 0x00000079e5e9dbab /system/lib64/libhidlbase.so+0x0000000000099bab
                                                                                                    #07 0x00000079e5eacf23 /system/lib64/libhidlbase.so+0x00000000000a8f23
                                                                                                    #08 0x00000079e6de767f /system/lib64/libutils.so+0x000000000001567f
                                                                                                    #09 0x00000079e5fa1d3f /system/lib64/libandroid_runtime.so+0x00000000000a0d3f
                                                                                                    #10 0x00000079e6de6f17 /system/lib64/libutils.so+0x0000000000014f17
                                                                                                    #11 0x00000079e76b0c0b /apex/com.android.runtime/lib64/bionic/libc.so+0x00000000000b0c0b
                                                                                                    #12 0x00000079e76505d3 /apex/com.android.runtime/lib64/bionic/libc.so+0x00000000000505d3
                                                                                                    #13 0xffffffffffffffff <unknown>
2024-03-26 18:48:56.282  2013-2057  libc                    com.android.bluetooth                A  Fatal signal 6 (SIGABRT), code -1 (SI_QUEUE) in tid 2057 (HwBinder:2013_1), pid 2013 (droid.bluetooth)
2024-03-26 18:48:56.348  2079-2079  DEBUG                   pid-2079                             A  *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***
2024-03-26 18:48:56.348  2079-2079  DEBUG                   pid-2079                             A  Build fingerprint: 'WIF/rk3399_Android11/rk3399_Android11:11/RD2A.211001.002/20240326.180250:userdebug/release-keys'
2024-03-26 18:48:56.348  2079-2079  DEBUG                   pid-2079                             A  Revision: '0'
2024-03-26 18:48:56.348  2079-2079  DEBUG                   pid-2079                             A  ABI: 'arm64'
2024-03-26 18:48:56.349  2079-2079  DEBUG                   pid-2079                             A  Timestamp: 2024-03-26 18:48:56+0800
2024-03-26 18:48:56.349  2079-2079  DEBUG                   pid-2079                             A  pid: 2013, tid: 2057, name: HwBinder:2013_1  >>> com.android.bluetooth <<<
2024-03-26 18:48:56.349  2079-2079  DEBUG                   pid-2079                             A  uid: 1002
2024-03-26 18:48:56.349  2079-2079  DEBUG                   pid-2079                             A  signal 6 (SIGABRT), code -1 (SI_QUEUE), fault addr --------
2024-03-26 18:48:56.349  2079-2079  DEBUG                   pid-2079                             A  Abort message: '[0326/184856.263475:FATAL:hci_layer_android.cc(102)] Check failed: status == Status::SUCCESS. 
                                                                                                    #00 0x00000076ecbf938f /system/lib64/libchrome.so+0x00000000000b738f
                                                                                                    #01 0x00000076ec54fd8b /system/lib64/libbluetooth.so+0x00000000002cfd8b
                                                                                                    #02 0x00000076ec9ed57b /system/lib64/android.hardware.bluetooth@1.0.so+0x000000000001b57b
                                                                                                    #03 0x00000076ec9aec3b /system/lib64/android.hardware.bluetooth@1.1.so+0x000000000001bc3b
                                                                                                    #04 0x00000079e5e9889b /system/lib64/libhidlbase.so+0x000000000009489b
                                                                                                    #05 0x00000079e5e9c94f /system/lib64/libhidlbase.so+0x000000000009894f
                                                                                                    #06 0x00000079e5e9dbab /system/lib64/libhidlbase.so+0x0000000000099bab
                                                                                                    #07 0x00000079e5eacf23 /system/lib64/libhidlbase.so+0x00000000000a8f23
                                                                                                    #08 0x00000079e6de767f /system/lib64/libutils.so+0x000000000001567f
                                                                                                    #09 0x00000079e5fa1d3f /system/lib64/libandroid_runtime.so+0x00000000000a0d3f
                                                                                                    #10 0x00000079e6de6f17 /system/lib64/libutils.so+0x0000000000014f17
                                                                                                    #11 0x00000079e76b0c0b /apex/com.android.runtime/lib64/bionic/libc.so+0x00000000000b0c0b
                                                                                                    #12 0x00000079e76505d3 /apex/com.android.runtime/lib64/bionic/libc.so+0x00000000000505d3
                                                                                                    #13 0xffffffffffffffff <unknown>
2024-03-26 18:48:56.349  2079-2079  DEBUG                   pid-2079                             A      x0  0000000000000000  x1  0000000000000809  x2  0000000000000006  x3  00000076da032e80
2024-03-26 18:48:56.349  2079-2079  DEBUG                   pid-2079                             A      x4  fefefefefefeff00  x5  fefefefefefeff00  x6  fefefefefefeff00  x7  7f7f7f7f7f7f7f7f
2024-03-26 18:48:56.349  2079-2079  DEBUG                   pid-2079                             A      x8  00000000000000f0  x9  00000079e76207e0  x10 ffffff80fffffbdf  x11 0000000000000001
2024-03-26 18:48:56.349  2079-2079  DEBUG                   pid-2079                             A      x12 00000076da031c90  x13 0000000000000467  x14 00000076da031d40  x15 0000000029aaaaf1
2024-03-26 18:48:56.349  2079-2079  DEBUG                   pid-2079                             A      x16 00000079e76b9c80  x17 00000079e769b3c0  x18 00000076d9d9a008  x19 00000000000000ac
2024-03-26 18:48:56.349  2079-2079  DEBUG                   pid-2079                             A      x20 00000000000007dd  x21 00000000000000b2  x22 0000000000000809  x23 00000000ffffffff
2024-03-26 18:48:56.349  2079-2079  DEBUG                   pid-2079                             A      x24 00000076ecc6f000  x25 00000079e76bcf28  x26 00000076da034000  x27 00000076da032f78
2024-03-26 18:48:56.349  2079-2079  DEBUG                   pid-2079                             A      x28 00000000000fc000  x29 00000076da032f00
2024-03-26 18:48:56.349  2079-2079  DEBUG                   pid-2079                             A      lr  00000079e764e544  sp  00000076da032e60  pc  00000079e764e574  pst 0000000000000000
2024-03-26 18:48:56.461  2079-2079  DEBUG                   pid-2079                             A  backtrace:
2024-03-26 18:48:56.461  2079-2079  DEBUG                   pid-2079                             A        #00 pc 000000000004e574  /apex/com.android.runtime/lib64/bionic/libc.so (abort+180) (BuildId: 0a481e8df134382e9d3effff2fce8b74)
2024-03-26 18:48:56.461  2079-2079  DEBUG                   pid-2079                             A        #01 pc 000000000009d7e4  /system/lib64/libchrome.so (base::debug::BreakDebugger()+20) (BuildId: d09629fde1649584555f8bdbb82b7e43)
2024-03-26 18:48:56.461  2079-2079  DEBUG                   pid-2079                             A        #02 pc 00000000000b77d0  /system/lib64/libchrome.so (logging::LogMessage::~LogMessage()+1312) (BuildId: d09629fde1649584555f8bdbb82b7e43)
2024-03-26 18:48:56.461  2079-2079  DEBUG                   pid-2079                             A        #03 pc 00000000002cfd88  /system/lib64/libbluetooth.so (BluetoothHciCallbacks::initializationComplete(android::hardware::bluetooth::V1_0::Status)+120) (BuildId: 616a7df9bc66978f60022850ffbc59ad)
2024-03-26 18:48:56.461  2079-2079  DEBUG                   pid-2079                             A        #04 pc 000000000001b578  /system/lib64/android.hardware.bluetooth@1.0.so (android::hardware::bluetooth::V1_0::BnHwBluetoothHciCallbacks::_hidl_initializationComplete(android::hidl::base::V1_0::BnHwBase*, android::hardware::Parcel const&, android::hardware::Parcel*, std::__1::function<void (android::hardware::Parcel&)>)+184) (BuildId: 0296ed46349be614c375cae0f90266ff)
2024-03-26 18:48:56.461  2079-2079  DEBUG                   pid-2079                             A        #05 pc 000000000001bc38  /system/lib64/android.hardware.bluetooth@1.1.so (android::hardware::bluetooth::V1_1::BnHwBluetoothHciCallbacks::onTransact(unsigned int, android::hardware::Parcel const&, android::hardware::Parcel*, unsigned int, std::__1::function<void (android::hardware::Parcel&)>)+552) (BuildId: 487535fb4e5d76b170fabe39fc61ca32)
2024-03-26 18:48:56.461  2079-2079  DEBUG                   pid-2079                             A        #06 pc 0000000000094898  /system/lib64/libhidlbase.so (android::hardware::BHwBinder::transact(unsigned int, android::hardware::Parcel const&, android::hardware::Parcel*, unsigned int, std::__1::function<void (android::hardware::Parcel&)>)+72) (BuildId: 3cfaecb108d863d40a3755a85e31cc72)
2024-03-26 18:48:56.461  2079-2079  DEBUG                   pid-2079                             A        #07 pc 000000000009894c  /system/lib64/libhidlbase.so (android::hardware::IPCThreadState::getAndExecuteCommand()+1076) (BuildId: 3cfaecb108d863d40a3755a85e31cc72)
2024-03-26 18:48:56.461  2079-2079  DEBUG                   pid-2079                             A        #08 pc 0000000000099ba8  /system/lib64/libhidlbase.so (android::hardware::IPCThreadState::joinThreadPool(bool)+96) (BuildId: 3cfaecb108d863d40a3755a85e31cc72)
2024-03-26 18:48:56.461  2079-2079  DEBUG                   pid-2079                             A        #09 pc 00000000000a8f20  /system/lib64/libhidlbase.so (android::hardware::PoolThread::threadLoop()+24) (BuildId: 3cfaecb108d863d40a3755a85e31cc72)
2024-03-26 18:48:56.461  2079-2079  DEBUG                   pid-2079                             A        #10 pc 000000000001567c  /system/lib64/libutils.so (android::Thread::_threadLoop(void*)+260) (BuildId: c081ab14bd4aef44c9c459d77d8c9b48)
2024-03-26 18:48:56.461  2079-2079  DEBUG                   pid-2079                             A        #11 pc 00000000000a0d3c  /system/lib64/libandroid_runtime.so (android::AndroidRuntime::javaThreadShell(void*)+140) (BuildId: f150bb818ae6dc2113b7ba0bfbc343a8)
2024-03-26 18:48:56.462  2079-2079  DEBUG                   pid-2079                             A        #12 pc 0000000000014f14  /system/lib64/libutils.so (thread_data_t::trampoline(thread_data_t const*)+412) (BuildId: c081ab14bd4aef44c9c459d77d8c9b48)
2024-03-26 18:48:56.462  2079-2079  DEBUG                   pid-2079                             A        #13 pc 00000000000b0c08  /apex/com.android.runtime/lib64/bionic/libc.so (__pthread_start(void*)+64) (BuildId: 0a481e8df134382e9d3effff2fce8b74)
2024-03-26 18:48:56.462  2079-2079  DEBUG                   pid-2079                             A        #14 pc 00000000000505d0  /apex/com.android.runtime/lib64/bionic/libc.so (__start_thread+64) (BuildId: 0a481e8df134382e9d3effff2fce8b74)
2024-03-26 18:48:57.162   263-263   tombstoned              tombstoned                           E  Tombstone written to: /data/tombstones/tombstone_10
2024-03-26 18:48:57.239   276-2076  android.ha...h@1.0-impl and...ardware.bluetooth@1.0-service  E  VendorInterface -> Unable to call initializationComplete()
2024-03-26 18:48:57.242   444-488   BluetoothManagerService system_process                       E  MESSAGE_BLUETOOTH_SERVICE_DISCONNECTED(1)
2024-03-26 18:48:57.243   444-2010  ActivityManager         system_process                       W  Scheduling restart of crashed service com.android.bluetooth/.btservice.AdapterService in 1000ms for connection
2024-03-26 18:48:57.780  2096-2126  bt_btif_storage         com.android.bluetooth                E  btif_storage_get_adapter_property: Controller not ready! Unable to return Bluetooth Address
2024-03-26 18:48:57.780  2096-2126  BluetoothServiceJni     com.android.bluetooth                E  adapter_properties_callback: Status 1 is incorrect
2024-03-26 18:48:57.875  2091-2091  android.ha....0-service pid-2091                             E  found device pid:vid :024c:c821: Permission denied
2024-03-26 18:48:57.875  2091-2091  android.ha....0-service pid-2091                             E  check_wifi_chip_type_string : RTL8821CS: Permission denied
2024-03-26 18:48:57.876  2091-2091  android.ha....0-service pid-2091                             E  vendor storage read success
2024-03-26 18:48:57.876  2091-2091  android.ha....0-service pid-2091                             E  Got local bdaddr for vendor storage 22:22:D1:CC:6E:CF
2024-03-26 18:48:57.878  2091-2091  bt_h5_int               pid-2091                             E  OsAllocateTimer rtk_parse sigev.sigev_notify_thread_id = syscall(__NR_gettid)!
2024-03-26 18:48:57.878  2091-2091  bt_h5_int               pid-2091                             E  OsAllocateTimer rtk_parse sigev.sigev_notify_thread_id = syscall(__NR_gettid)!
2024-03-26 18:48:57.879  2091-2091  libbt_vendor            pid-2091                             E  bt_wake_up_host_mode_set(1)
2024-03-26 18:48:57.880  2091-2091  bt_upio                 pid-2091                             E  bt_wake_up_host_mode_set
2024-03-26 18:48:57.880  2091-2091  bt_upio                 pid-2091                             E  bt_wake_up_host_mode_set path:/proc/bluetooth/sleep/lpm
2024-03-26 18:48:57.880  2091-2091  bt_upio                 pid-2091                             E  bt_wake_up_host_mode_set fd:8 = open(path, O_RDWR): open(/proc/bluetooth/sleep/lpm) success
2024-03-26 18:48:57.880  2091-2091  bt_upio                 pid-2091                             E  bt_wake_up_host_mode_set buffer:49
2024-03-26 18:48:57.880  2091-2091  libbt_vendor            pid-2091                             E  rtk_btsnoop_dump = 0, rtk_btsnoop_save_log = 0

```

## 代码流程跟踪

### Settings

./src/com/android/settings/bluetooth/BluetoothEnabler.java

```java

public final class BluetoothEnabler implements SwitchWidgetController.OnSwitchChangeListener {

    private final BluetoothAdapter mBluetoothAdapter;
    
    public BluetoothEnabler(Context context, SwitchWidgetController switchController,
            MetricsFeatureProvider metricsFeatureProvider, int metricsEvent,
            RestrictionUtils restrictionUtils) {

        mBluetoothAdapter = BluetoothAdapter.getDefaultAdapter();

    }

    @Override
    public boolean onSwitchToggled(boolean isChecked) {

        if (mBluetoothAdapter != null) {
            boolean status = setBluetoothEnabled(isChecked);
            
        }

    }

    private boolean setBluetoothEnabled(boolean isEnabled) {
        return isEnabled ? mBluetoothAdapter.enable() : mBluetoothAdapter.disable();
    }

}

```

frameworks/base/core/java/android/bluetooth/BluetoothAdapter.java

```java

public final class BluetoothAdapter {

    public static synchronized BluetoothAdapter getDefaultAdapter() {
        if (sAdapter == null) {
            IBinder b = ServiceManager.getService(BLUETOOTH_MANAGER_SERVICE);
            if (b != null) {
                IBluetoothManager managerService = IBluetoothManager.Stub.asInterface(b);
                sAdapter = new BluetoothAdapter(managerService);
            } else {
                Log.e(TAG, "Bluetooth binder is null");
            }
        }
        return sAdapter;
    }

    @RequiresPermission(Manifest.permission.BLUETOOTH_ADMIN)
    public boolean enable() {
        if (isEnabled()) {
            if (DBG) {
                Log.d(TAG, "enable(): BT already enabled!");
            }
            return true;
        }
        try {
            return mManagerService.enable(ActivityThread.currentPackageName());
        } catch (RemoteException e) {
            Log.e(TAG, "", e);
        }
        return false;
    }

}

```

### SystemServer

**正常日志**

```txt

2024-03-26 18:48:51.893   444-526   BluetoothManagerService system_process                       D  enable(com.android.settings):  mBluetooth =null mBinding = false mState = OFF
2024-03-26 18:48:51.894   444-526   BluetoothManagerService system_process                       D  enable returning
2024-03-26 18:48:51.894   444-488   BluetoothManagerService system_process                       D  MESSAGE_ENABLE(0): mBluetooth = null
2024-03-26 18:48:51.894   444-488   BluetoothManagerService system_process                       D  binding Bluetooth service
2024-03-26 18:48:52.061   444-444   BluetoothManagerService system_process                       D  Bluetooth Adapter name changed to rk3399
2024-03-26 18:48:52.061   444-444   BluetoothManagerService system_process                       D  Stored Bluetooth name: rk3399
2024-03-26 18:48:52.119   444-444   BluetoothManagerService system_process                       D  BluetoothServiceConnection: com.android.bluetooth.btservice.AdapterService
2024-03-26 18:48:52.119   444-488   BluetoothManagerService system_process                       D  MESSAGE_BLUETOOTH_SERVICE_CONNECTED: 1
2024-03-26 18:48:52.120   444-488   BluetoothManagerService system_process                       D  Broadcasting onBluetoothServiceUp() to 5 receivers.
2024-03-26 18:48:52.123   444-488   BluetoothManagerService system_process                       D  MESSAGE_BLUETOOTH_STATE_CHANGE: OFF > BLE_TURNING_ON
2024-03-26 18:48:52.123   444-488   BluetoothManagerService system_process                       D  Sending BLE State Change: OFF > BLE_TURNING_ON
--------- beginning of crash
2024-03-26 18:48:57.242   444-444   BluetoothManagerService system_process                       D  BluetoothServiceConnection, disconnected: com.android.bluetooth.btservice.AdapterService
2024-03-26 18:48:57.242   444-488   BluetoothManagerService system_process                       E  MESSAGE_BLUETOOTH_SERVICE_DISCONNECTED(1)
2024-03-26 18:48:57.242   444-488   BluetoothManagerService system_process                       D  Broadcasting onBluetoothServiceDown() to 4 receivers.
2024-03-26 18:48:57.643   444-488   BluetoothManagerService system_process                       D  MESSAGE_RESTART_BLUETOOTH_SERVICE: retry count=1

```

frameworks/base/services/core/java/com/android/server/BluetoothManagerService.java

```java

class BluetoothManagerService extends IBluetoothManager.Stub {

    private BluetoothServiceConnection mConnection = new BluetoothServiceConnection();

    public boolean enable(String packageName) throws RemoteException {
        if (DBG) {
            Slog.d(TAG, "enable(" + packageName + "):  mBluetooth =" + mBluetooth + " mBinding = "
                    + mBinding + " mState = " + BluetoothAdapter.nameForState(mState));
        }

        synchronized (mReceiver) {
            // waive WRITE_SECURE_SETTINGS permission check
            sendEnableMsg(false,
                    BluetoothProtoEnums.ENABLE_DISABLE_REASON_APPLICATION_REQUEST, packageName);
        }
        if (DBG) {
            Slog.d(TAG, "enable returning");
        }
        return true;
    }

    private void handleEnable(boolean quietMode) {
        mQuietEnable = quietMode;

        try {
            mBluetoothLock.writeLock().lock();
            if ((mBluetooth == null) && (!mBinding)) {
                Slog.d(TAG, "binding Bluetooth service");
                //Start bind timeout and bind
                Message timeoutMsg = mHandler.obtainMessage(MESSAGE_TIMEOUT_BIND);
                mHandler.sendMessageDelayed(timeoutMsg, TIMEOUT_BIND_MS);
                Intent i = new Intent(IBluetooth.class.getName());
                if (!doBind(i, mConnection, Context.BIND_AUTO_CREATE | Context.BIND_IMPORTANT,
                        UserHandle.CURRENT)) {
                    mHandler.removeMessages(MESSAGE_TIMEOUT_BIND);
                } else {
                    mBinding = true;
                }
            } else if (mBluetooth != null) {
                //Enable bluetooth
                try {
                    if (!mBluetooth.enable(mQuietEnable)) {
                        Slog.e(TAG, "IBluetooth.enable() returned false");
                    }
                } catch (RemoteException e) {
                    Slog.e(TAG, "Unable to call enable()", e);
                }
            }
        } finally {
            mBluetoothLock.writeLock().unlock();
        }
    }

    boolean doBind(Intent intent, ServiceConnection conn, int flags, UserHandle user) {
        ComponentName comp = intent.resolveSystemService(mContext.getPackageManager(), 0);
        intent.setComponent(comp);
        if (comp == null || !mContext.bindServiceAsUser(intent, conn, flags, user)) {
            Slog.e(TAG, "Fail to bind to: " + intent);
            return false;
        }
        return true;
    }

}

```

### Bluetooth App

**日志**

```txt

2024-03-26 18:48:52.026  2013-2013  droid.bluetoot          pid-2013                             I  [0326/184852.026649:INFO:btif_config_cache.cc(61)] BtifConfigCache, capacity: 10000
2024-03-26 18:48:52.028  2013-2013  BluetoothServiceJni     pid-2013                             I  hal_util_load_bt_library: loaded Bluetooth library successfully
2024-03-26 18:48:52.028  2013-2013  BluetoothAdapterService pid-2013                             D  onCreate()
2024-03-26 18:48:52.040  2013-2013  AdapterState            pid-2013                             D  make() - Creating AdapterState
2024-03-26 18:48:52.042  2013-2034  AdapterState            pid-2013                             I  OFF : entered 
2024-03-26 18:48:52.042  2013-2034  AdapterProperties       pid-2013                             D  Setting state to OFF
2024-03-26 18:48:52.044  2013-2013  BluetoothK...oreService pid-2013                             D  new BluetoothKeystoreService isNiapMode: false
2024-03-26 18:48:52.044  2013-2013  BluetoothK...oreService pid-2013                             D  start
2024-03-26 18:48:52.045  2013-2013  droid.bluetoot          pid-2013                             I  [0326/184852.045529:INFO:com_android_bluetooth_btservice_BluetoothKeystore.cpp(97)] classInitNative: succeeds
2024-03-26 18:48:52.045  2013-2013  BluetoothK...oreService pid-2013                             D  setBluetoothKeystoreService(): set to: com.android.bluetooth.btservice.bluetoothkeystore.BluetoothKeystoreService@133a49
2024-03-26 18:48:52.046  2013-2013  BluetoothK...oreService pid-2013                             D  loadConfigData
2024-03-26 18:48:52.055  2013-2013  BluetoothK...oreService pid-2013                             D  getCompareResult: 0
2024-03-26 18:48:52.056  2013-2013  bt_btif                 pid-2013                             I  init: start restricted = 0 ; niap = 0, config compare result = 0
2024-03-26 18:48:52.056  2013-2013  bt_btif                 pid-2013                             I  init Preserving legacy bluetooth functionality
2024-03-26 18:48:52.056  2013-2013  bt_osi_all...on_tracker pid-2013                             D  canary initialized
2024-03-26 18:48:52.057  2013-2037  droid.bluetoot          pid-2013                             I  [0326/184852.057007:INFO:message_loop_thread.cc(175)] Run: message loop starting for thread bt_stack_manager_thread
2024-03-26 18:48:52.057  2013-2037  bt_stack_manager        pid-2013                             I  event_init_stack is initializing the stack
2024-03-26 18:48:52.058  2013-2040  bt_osi_thread           pid-2013                             I  run_thread: thread id 2040, thread name alarm_default_ca started
2024-03-26 18:48:52.058  2013-2041  bt_osi_thread           pid-2013                             I  run_thread: thread id 2041, thread name alarm_dispatcher started
2024-03-26 18:48:52.058  2013-2037  bt_btif_core            pid-2013                             I  btif_init_bluetooth entered
2024-03-26 18:48:52.058  2013-2037  bt_stack_config         pid-2013                             I  init attempt to load stack conf from /etc/bluetooth/bt_stack.conf
2024-03-26 18:48:52.059  2013-2042  droid.bluetoot          pid-2013                             I  [0326/184852.059266:INFO:message_loop_thread.cc(175)] Run: message loop starting for thread bt_jni_thread
2024-03-26 18:48:52.059  2013-2037  bt_btif_core            pid-2013                             I  btif_init_bluetooth finished
2024-03-26 18:48:52.059  2013-2037  bt_stack_manager        pid-2013                             I  event_init_stack finished
2024-03-26 18:48:52.059  2013-2013  bt_osi_wakelock         pid-2013                             I  wakelock_set_os_callouts set to non-native
2024-03-26 18:48:52.059  2013-2013  bt_btif                 pid-2013                             I  get_profile_interface: id = socket
2024-03-26 18:48:52.060  2013-2042  bt_btif_storage         pid-2013                             E  btif_storage_get_adapter_property: Controller not ready! Unable to return Bluetooth Address
2024-03-26 18:48:52.060  2013-2042  BluetoothServiceJni     pid-2013                             E  adapter_properties_callback: Status 1 is incorrect
2024-03-26 18:48:52.061  2013-2042  AdapterProperties       pid-2013                             D  Name is: rk3399
2024-03-26 18:48:52.061  2013-2042  AdapterProperties       pid-2013                             D  BT Class:1a0110
2024-03-26 18:48:52.064  2013-2013  BluetoothK...oreService pid-2013                             D  initJni()
2024-03-26 18:48:52.065  2013-2013  bt_btif                 pid-2013                             I  get_profile_interface: id = bluetooth_keystore
2024-03-26 18:48:52.067  2013-2013  bt_btif                 pid-2013                             I  get_profile_interface: id = sdp
2024-03-26 18:48:52.069  2013-2013  BluetoothAdapterService pid-2013                             I  Phone policy enabled
2024-03-26 18:48:52.072  2013-2013  BluetoothA...iceManager pid-2013                             D  start()
2024-03-26 18:48:52.092  2013-2043  BluetoothA...iceManager pid-2013                             D  onAudioDevicesAdded
2024-03-26 18:48:52.092  2013-2043  BluetoothA...iceManager pid-2013                             D  Audio device added: TXXAM type: 2
2024-03-26 18:48:52.092  2013-2043  BluetoothA...iceManager pid-2013                             D  Audio device added: TXXAM type: 15
2024-03-26 18:48:52.092  2013-2043  BluetoothA...iceManager pid-2013                             D  Audio device added: TXXAM type: 9
2024-03-26 18:48:52.092  2013-2043  BluetoothA...iceManager pid-2013                             D  Audio device added: TXXAM type: 25
2024-03-26 18:48:52.095  2013-2013  BluetoothDatabase       pid-2013                             D  start()
2024-03-26 18:48:52.097  2013-2013  BluetoothDatabase       pid-2013                             D  Load Database
2024-03-26 18:48:52.099  2013-2013  BluetoothAdapterService pid-2013                             D  setAdapterService() - trying to set service to com.android.bluetooth.btservice.AdapterService@6c09aaa
2024-03-26 18:48:52.116  2013-2045  BluetoothDatabase       pid-2013                             D  compactLastConnectionTime: Compacting metadata after load
2024-03-26 18:48:52.116  2013-2045  BluetoothDatabase       pid-2013                             I  cacheMetadata
2024-03-26 18:48:52.116  2013-2045  BluetoothDatabase       pid-2013                             V  cacheMetadata: found device LocalStorage
2024-03-26 18:48:52.116  2013-2045  BluetoothDatabase       pid-2013                             I  cacheMetadata: Database is ready
2024-03-26 18:48:52.118  2013-2013  BluetoothAdapterService pid-2013                             D  onBind()
2024-03-26 18:48:52.120  2013-2031  BluetoothAdapter        pid-2013                             D  onBluetoothServiceUp: com.android.bluetooth.btservice.AdapterService$AdapterServiceBinder@9ef6585
2024-03-26 18:48:52.121  2013-2031  BluetoothAdapterService pid-2013                             D  enable() - Enable called with quiet mode status =  false
2024-03-26 18:48:52.121  2013-2034  AdapterState            pid-2013                             I  BLE_TURNING_ON : entered 
2024-03-26 18:48:52.122  2013-2034  AdapterProperties       pid-2013                             D  Setting state to BLE_TURNING_ON
2024-03-26 18:48:52.122  2013-2034  BluetoothAdapterService pid-2013                             D  updateAdapterState() - Broadcasting state BLE_TURNING_ON to 1 receivers.
2024-03-26 18:48:52.149  2013-2034  BluetoothAdapterService pid-2013                             D  bleOnProcessStart()
2024-03-26 18:48:52.149  2013-2034  AdapterProperties       pid-2013                             I  init(), maxConnectedAudioDevices, default=5, propertyOverlayed=5, finalValue=5
2024-03-26 18:48:52.154  2013-2034  BluetoothAdapterService pid-2013                             D  bleOnProcessStart() - Make Bond State Machine
2024-03-26 18:48:52.154  2013-2034  BluetoothB...ateMachine pid-2013                             D  make
2024-03-26 18:48:52.157  2013-2050  BluetoothB...ateMachine pid-2013                             I  StableState(): Entering Off State
2024-03-26 18:48:52.165  2013-2013  BtGatt.JNI              pid-2013                             I  classInitNative(L875): classInitNative: Success!
2024-03-26 18:48:52.166  2013-2013  BtGatt.DebugUtils       pid-2013                             D  handleDebugAction() action=null
2024-03-26 18:48:52.167  2013-2013  BluetoothAdapterService pid-2013                             D  getAdapterService() - returning com.android.bluetooth.btservice.AdapterService@6c09aaa
2024-03-26 18:48:52.169  2013-2013  bt_btif                 pid-2013                             I  get_profile_interface: id = gatt
2024-03-26 18:48:52.170  2013-2013  BluetoothAdapterService pid-2013                             D  getAdapterService() - returning com.android.bluetooth.btservice.AdapterService@6c09aaa
2024-03-26 18:48:52.177  2013-2013  BluetoothAdapterService pid-2013                             D  getAdapterService() - returning com.android.bluetooth.btservice.AdapterService@6c09aaa
2024-03-26 18:48:52.178  2013-2037  bt_stack_manager        pid-2013                             I  event_start_up_stack is bringing up the stack
2024-03-26 18:48:52.178  2013-2037  bt_core_module          pid-2013                             I  module_start_up Starting module "btif_config_module"
2024-03-26 18:48:52.178  2013-2037  bt_core_module          pid-2013                             I  module_start_up Started module "btif_config_module"
2024-03-26 18:48:52.178  2013-2037  bt_core_module          pid-2013                             I  module_start_up Starting module "btsnoop_module"
2024-03-26 18:48:52.178  2013-2037  droid.bluetoot          pid-2013                             I  [0326/184852.178877:INFO:btsnoop.cc(207)] start_up: Snoop Logs disabled
2024-03-26 18:48:52.178  2013-2037  droid.bluetoot          pid-2013                             I  [0326/184852.178956:INFO:btsnoop.cc(338)] delete_btsnoop_files: Deleting snoop logs if they exist. filtered = 1
2024-03-26 18:48:52.179  2013-2037  droid.bluetoot          pid-2013                             I  [0326/184852.179526:INFO:btsnoop.cc(338)] delete_btsnoop_files: Deleting snoop logs if they exist. filtered = 0
2024-03-26 18:48:52.179  2013-2037  bt_core_module          pid-2013                             I  module_start_up Started module "btsnoop_module"
2024-03-26 18:48:52.179  2013-2037  bt_core_module          pid-2013                             I  module_start_up Starting module "hci_module"
2024-03-26 18:48:52.179  2013-2037  bt_hci                  pid-2013                             I  hci_module_start_up
2024-03-26 18:48:52.180  2013-2056  droid.bluetoot          pid-2013                             I  [0326/184852.180148:INFO:message_loop_thread.cc(175)] Run: message loop starting for thread bt_hci_thread
2024-03-26 18:48:52.180  2013-2037  bt_hci                  pid-2013                             D  hci_module_start_up starting async portion
2024-03-26 18:48:52.180  2013-2056  bt_hci                  pid-2013                             I  hci_initialize
2024-03-26 18:48:52.181  2013-2056  bt_hci                  pid-2013                             I  hci_initialize: IBluetoothHci::getService() returned 0xb4000078058dcf10 (remote)
--------- beginning of crash
2024-03-26 18:48:56.282  2013-2057  droid.bluetoot          pid-2013                             A  [0326/184856.263475:FATAL:hci_layer_android.cc(102)] Check failed: status == Status::SUCCESS. 
                                                                                                    #00 0x00000076ecbf938f /system/lib64/libchrome.so+0x00000000000b738f
                                                                                                    #01 0x00000076ec54fd8b /system/lib64/libbluetooth.so+0x00000000002cfd8b
                                                                                                    #02 0x00000076ec9ed57b /system/lib64/android.hardware.bluetooth@1.0.so+0x000000000001b57b
                                                                                                    #03 0x00000076ec9aec3b /system/lib64/android.hardware.bluetooth@1.1.so+0x000000000001bc3b
                                                                                                    #04 0x00000079e5e9889b /system/lib64/libhidlbase.so+0x000000000009489b
                                                                                                    #05 0x00000079e5e9c94f /system/lib64/libhidlbase.so+0x000000000009894f
                                                                                                    #06 0x00000079e5e9dbab /system/lib64/libhidlbase.so+0x0000000000099bab
                                                                                                    #07 0x00000079e5eacf23 /system/lib64/libhidlbase.so+0x00000000000a8f23
                                                                                                    #08 0x00000079e6de767f /system/lib64/libutils.so+0x000000000001567f
                                                                                                    #09 0x00000079e5fa1d3f /system/lib64/libandroid_runtime.so+0x00000000000a0d3f
                                                                                                    #10 0x00000079e6de6f17 /system/lib64/libutils.so+0x0000000000014f17
                                                                                                    #11 0x00000079e76b0c0b /apex/com.android.runtime/lib64/bionic/libc.so+0x00000000000b0c0b
                                                                                                    #12 0x00000079e76505d3 /apex/com.android.runtime/lib64/bionic/libc.so+0x00000000000505d3
                                                                                                    #13 0xffffffffffffffff <unknown>
2024-03-26 18:48:56.282  2013-2057  libc                    pid-2013                             A  Fatal signal 6 (SIGABRT), code -1 (SI_QUEUE) in tid 2057 (HwBinder:2013_1), pid 2013 (droid.bluetooth)

```

packages/apps/Bluetooth/src/com/android/bluetooth/btservice/AdapterService.java

```java

public class AdapterService extends Service {
    private static final String TAG = "BluetoothAdapterService";

    public synchronized boolean enable(boolean quietMode) {

        debugLog("enable() - Enable called with quiet mode status =  " + quietMode);
        mQuietmode = quietMode;
        mAdapterStateMachine.sendMessage(AdapterState.BLE_TURN_ON);
        return true;

    }

    native boolean enableNative();

}

```

**状态机**

packages/apps/Bluetooth/src/com/android/bluetooth/btservice/BondStateMachine.java

```java

final class BondStateMachine extends StateMachine {

    private class StableState extends State {}
    
    private class PendingCommandState extends State {}

}

```


**JNI**

packages/apps/Bluetooth/jni/com_android_bluetooth_btservice_AdapterService.cpp

```cpp


static jboolean enableNative(JNIEnv* env, jobject obj) {
  ALOGV("%s", __func__);

  if (!sBluetoothInterface) return JNI_FALSE;
  int ret = sBluetoothInterface->enable();
  return (ret == BT_STATUS_SUCCESS || ret == BT_STATUS_DONE) ? JNI_TRUE
                                                             : JNI_FALSE;
}


static void adapter_properties_callback(bt_status_t status, int num_properties,
                                        bt_property_t* properties) {
                                        
       
  ALOGV("%s: Status is: %d, Properties: %d", __func__, status, num_properties);

  if (status != BT_STATUS_SUCCESS) {
    ALOGE("%s: Status %d is incorrect", __func__, status);
    return;
  }
                                        
}

```

### 蓝牙协议栈

AOSP 中提供了蓝牙默认堆栈， 该堆栈实现常规蓝牙HAL

system/bt/btif

**日志**

```txt

2024-03-26 18:48:52.028  2013-2013  BluetoothServiceJni     pid-2013                             I  hal_util_load_bt_library: loaded Bluetooth library successfully
2024-03-26 18:48:52.056  2013-2013  bt_btif                 pid-2013                             I  init: start restricted = 0 ; niap = 0, config compare result = 0
2024-03-26 18:48:52.056  2013-2013  bt_btif                 pid-2013                             I  init Preserving legacy bluetooth functionality
2024-03-26 18:48:52.056  2013-2013  bt_osi_all...on_tracker pid-2013                             D  canary initialized
2024-03-26 18:48:52.057  2013-2037  droid.bluetoot          pid-2013                             I  [0326/184852.057007:INFO:message_loop_thread.cc(175)] Run: message loop starting for thread bt_stack_manager_thread
2024-03-26 18:48:52.057  2013-2037  bt_stack_manager        pid-2013                             I  event_init_stack is initializing the stack
2024-03-26 18:48:52.058  2013-2040  bt_osi_thread           pid-2013                             I  run_thread: thread id 2040, thread name alarm_default_ca started
2024-03-26 18:48:52.058  2013-2041  bt_osi_thread           pid-2013                             I  run_thread: thread id 2041, thread name alarm_dispatcher started
2024-03-26 18:48:52.058  2013-2037  bt_btif_core            pid-2013                             I  btif_init_bluetooth entered
2024-03-26 18:48:52.058  2013-2037  bt_stack_config         pid-2013                             I  init attempt to load stack conf from /etc/bluetooth/bt_stack.conf
2024-03-26 18:48:52.059  2013-2042  droid.bluetoot          pid-2013                             I  [0326/184852.059266:INFO:message_loop_thread.cc(175)] Run: message loop starting for thread bt_jni_thread
2024-03-26 18:48:52.059  2013-2037  bt_btif_core            pid-2013                             I  btif_init_bluetooth finished
2024-03-26 18:48:52.059  2013-2037  bt_stack_manager        pid-2013                             I  event_init_stack finished
2024-03-26 18:48:52.059  2013-2013  bt_osi_wakelock         pid-2013                             I  wakelock_set_os_callouts set to non-native
2024-03-26 18:48:52.059  2013-2013  bt_btif                 pid-2013                             I  get_profile_interface: id = socket


// 错误日志
2024-03-26 18:48:52.060  2013-2042  bt_btif_storage         pid-2013                             E  btif_storage_get_adapter_property: Controller not ready! Unable to return Bluetooth Address


2024-03-26 18:48:52.065  2013-2013  bt_btif                 pid-2013                             I  get_profile_interface: id = bluetooth_keystore
2024-03-26 18:48:52.067  2013-2013  bt_btif                 pid-2013                             I  get_profile_interface: id = sdp
2024-03-26 18:48:52.169  2013-2013  bt_btif                 pid-2013                             I  get_profile_interface: id = gatt
2024-03-26 18:48:52.178  2013-2037  bt_stack_manager        pid-2013                             I  event_start_up_stack is bringing up the stack
2024-03-26 18:48:52.178  2013-2037  bt_core_module          pid-2013                             I  module_start_up Starting module "btif_config_module"
2024-03-26 18:48:52.178  2013-2037  bt_core_module          pid-2013                             I  module_start_up Started module "btif_config_module"
2024-03-26 18:48:52.178  2013-2037  bt_core_module          pid-2013                             I  module_start_up Starting module "btsnoop_module"
2024-03-26 18:48:52.179  2013-2037  bt_core_module          pid-2013                             I  module_start_up Started module "btsnoop_module"
2024-03-26 18:48:52.179  2013-2037  bt_core_module          pid-2013                             I  module_start_up Starting module "hci_module"
2024-03-26 18:48:52.179  2013-2037  bt_hci                  pid-2013                             I  hci_module_start_up
2024-03-26 18:48:52.180  2013-2056  droid.bluetoot          pid-2013                             I  [0326/184852.180148:INFO:message_loop_thread.cc(175)] Run: message loop starting for thread bt_hci_thread
2024-03-26 18:48:52.180  2013-2037  bt_hci                  pid-2013                             D  hci_module_start_up starting async portion
2024-03-26 18:48:52.180  2013-2056  bt_hci                  pid-2013                             I  hci_initialize
2024-03-26 18:48:52.181  2013-2056  bt_hci                  pid-2013                             I  hci_initialize: IBluetoothHci::getService() returned 0xb4000078058dcf10 (remote)

```

./src/btif_storage.cc

```cpp

bt_status_t btif_storage_get_adapter_property(bt_property_t* property) {
  /* Special handling for adapter address and BONDED_DEVICES */
  if (property->type == BT_PROPERTY_BDADDR) {
    RawAddress* bd_addr = (RawAddress*)property->val;
    /* Fetch the local BD ADDR */
    const controller_t* controller = controller_get_interface();
    if (!controller->get_is_ready()) {
      LOG_ERROR(LOG_TAG,
                "%s: Controller not ready! Unable to return Bluetooth Address",
                __func__);
      *bd_addr = RawAddress::kEmpty;
      return BT_STATUS_FAIL;
    } else {
      LOG_ERROR(LOG_TAG, "%s: Controller ready!", __func__);
      *bd_addr = *controller->get_address();
    }
    property->len = RawAddress::kLength;
    return BT_STATUS_SUCCESS;
  }
}

```

./system/bt/hci/src/hci_layer_android.cc

```cpp

class BluetoothHciCallbacks : public V1_1::IBluetoothHciCallbacks {

  Return<void> initializationComplete(Status status) override {
    if (hci_is_root_inflammation_event_received()) {
      // Ignore the initializationComplete here as we have already received
      // root inflammation event earlier.
      LOG_ERROR(
          LOG_TAG,
          "initializationComplete after root inflammation event! status=%d",
          status);
      return Void();
    }
    CHECK(status == Status::SUCCESS);
    initialization_complete();
    return Void();
  }

}

```

system/bt/vendor_libs/linux/interface/bluetooth_hci.cc

```cpp

Return<void> BluetoothHci::initialize_impl(
    const ::android::sp<V1_0::IBluetoothHciCallbacks>& cb,
    const ::android::sp<V1_1::IBluetoothHciCallbacks>& cb_1_1) {
  ALOGI("BluetoothHci::initialize()");
  if (cb == nullptr) {
    ALOGE("cb == nullptr! -> Unable to call initializationComplete(ERR)");
    return Void();
  }

  death_recipient_->setHasDied(false);
  cb->linkToDeath(death_recipient_, 0);
  int hci_fd = openBtHci();
  auto hidl_status = cb->initializationComplete(
      hci_fd > 0 ? V1_0::Status::SUCCESS : V1_0::Status::INITIALIZATION_ERROR);
  if (!hidl_status.isOk()) {
      ALOGE("VendorInterface -> Unable to call initializationComplete(ERR)");
  }

}

```

### HIDL

AOSP 提供的规范接口

```txt

hardware/interfaces/bluetooth$ tree -L 3
.
├── 1.0
│   ├── Android.bp
│   ├── default
│   │   ├── Android.bp
│   │   ├── android.hardware.bluetooth@1.0-service.rc
│   │   ├── async_fd_watcher.cc
│   │   ├── async_fd_watcher.h
│   │   ├── bluetooth_address.cc
│   │   ├── bluetooth_address.h
│   │   ├── bluetooth_hci.cc
│   │   ├── bluetooth_hci.h
│   │   ├── bt_vendor_lib.h
│   │   ├── h4_protocol.cc
│   │   ├── h4_protocol.h
│   │   ├── hci_internals.h
│   │   ├── hci_packetizer.cc
│   │   ├── hci_packetizer.h
│   │   ├── hci_protocol.cc
│   │   ├── hci_protocol.h
│   │   ├── mct_protocol.cc
│   │   ├── mct_protocol.h
│   │   ├── OWNERS
│   │   ├── service.cpp
│   │   ├── test
│   │   ├── vendor_interface.cc
│   │   └── vendor_interface.h
│   ├── IBluetoothHciCallbacks.hal
│   ├── IBluetoothHci.hal
│   ├── types.hal
│   └── vts
│       ├── functional
│       └── OWNERS
├── 1.1
│   ├── Android.bp
│   ├── default
│   │   ├── Android.bp
│   │   ├── android.hardware.bluetooth@1.1-service.rc
│   │   ├── bluetooth_hci.cc
│   │   ├── bluetooth_hci.h
│   │   ├── OWNERS
│   │   └── service.cpp
│   ├── IBluetoothHciCallbacks.hal
│   ├── IBluetoothHci.hal
│   └── vts
│       ├── functional
│       └── OWNERS
├── a2dp
│   └── 1.0
│       ├── Android.bp
│       ├── default
│       ├── IBluetoothAudioHost.hal
│       ├── IBluetoothAudioOffload.hal
│       ├── types.hal
│       └── vts
└── audio
    └── 2.0
        ├── Android.bp
        ├── default
        ├── IBluetoothAudioPort.hal
        ├── IBluetoothAudioProvider.hal
        ├── IBluetoothAudioProvidersFactory.hal
        ├── types.hal
        └── vts

```

### 供应商实现

供应商使用硬件接口语言HIDL与蓝牙堆栈交互

**源码目录**

```txt

hardware/realtek/rtkbt$ tree
.
├── Android.mk
├── bluetooth
│   └── bdroid_buildcfg.h
├── code
│   ├── Android.mk
│   ├── libbt-vendor
│   │   ├── Android.mk
│   │   ├── codec
│   │   │   ├── Android.mk
│   │   │   ├── plc
│   │   │   │   ├── sbcplc.c
│   │   │   │   └── sbcplc.h
│   │   │   └── sbc
│   │   │       ├── formats.h
│   │   │       ├── sbc.c
│   │   │       ├── sbc.h
│   │   │       ├── sbc_math.h
│   │   │       ├── sbc_primitives_armv6.c
│   │   │       ├── sbc_primitives_armv6.h
│   │   │       ├── sbc_primitives.c
│   │   │       ├── sbc_primitives.h
│   │   │       ├── sbc_primitives_iwmmxt.c
│   │   │       ├── sbc_primitives_iwmmxt.h
│   │   │       ├── sbc_primitives_mmx.c
│   │   │       ├── sbc_primitives_mmx.h
│   │   │       ├── sbc_primitives_neon.c
│   │   │       ├── sbc_primitives_neon.h
│   │   │       ├── sbc_private.h
│   │   │       └── sbc_tables.h
│   │   ├── include
│   │   │   ├── bt_list.h
│   │   │   ├── bt_skbuff.h
│   │   │   ├── bt_vendor_rtk.h
│   │   │   ├── hardware.h
│   │   │   ├── hci_h5_int.h
│   │   │   ├── rtk_btservice.h
│   │   │   ├── rtk_btsnoop_net.h
│   │   │   ├── rtk_common.h
│   │   │   ├── rtk_hcidefs.h
│   │   │   ├── rtk_parse.h
│   │   │   ├── rtk_poll.h
│   │   │   ├── rtk_socket.h
│   │   │   ├── unused.h
│   │   │   ├── upio.h
│   │   │   └── userial_vendor.h
│   │   ├── MODULE_LICENSE_APACHE2
│   │   ├── NOTICE
│   │   └── src
│   │       ├── Android.mk
│   │       ├── bt_list.c
│   │       ├── bt_skbuff.c
│   │       ├── bt_vendor_rtk.c
│   │       ├── hardware.c
│   │       ├── hardware_uart.c
│   │       ├── hardware_usb.c
│   │       ├── hci_h5.c
│   │       ├── rtk_btservice.c
│   │       ├── rtk_btsnoop_net.c
│   │       ├── rtk_heartbeat.c
│   │       ├── rtk_parse.c
│   │       ├── rtk_poll.c
│   │       ├── rtk_socket.c
│   │       ├── upio.c
│   │       └── userial_vendor.c
│   └── rtkcmd
│       ├── Android.mk
│       └── rtkcmd.c
├── rtkbt.mk
└── vendor
    ├── etc
    │   └── bluetooth
    │       ├── rtkbt.conf
    │       └── rtkbt_S0.conf
    ├── firmware
    │   ├── BT_Firmware.mk
    │   ├── fw_info.txt
    │   ├── readme.txt
    │   ├── rtl8821cs_config
    │   ├── rtl8821cs_config_vendor
    │   ├── rtl8821cs_fw
    └── firmware_box
        ├── fw_info.txt
        ├── readme.txt
        ├── rtl8821cs_config
        ├── rtl8821cs_config_vendor
        ├── rtl8821cs_fw
        └── TV_Firmware.mk

```

**日志**

```txt

2024-03-26 20:14:01.178   277-277   HidlServiceManagement   pid-277                              I  Removing namespace from process name android.hardware.bluetooth@1.0-service to bluetooth@1.0-service.
---------------------------- PROCESS STARTED (1127) for package com.wif.baseservice ----------------------------
2024-03-26 20:14:34.312   277-290   android.ha...h@1.0-impl and...ardware.bluetooth@1.0-service  I  BluetoothHci::initialize()
2024-03-26 20:14:34.312   277-290   android.ha....0-service and...ardware.bluetooth@1.0-service  E  found device pid:vid :024c:c821: Permission denied
2024-03-26 20:14:34.312   277-290   android.ha....0-service and...ardware.bluetooth@1.0-service  E  check_wifi_chip_type_string : RTL8821CS: Permission denied
2024-03-26 20:14:34.312   277-290   android.ha...h@1.0-impl and...ardware.bluetooth@1.0-service  D  Open: libbt-vendor-realtek.so
2024-03-26 20:14:34.316   277-290   android.ha....0-service and...ardware.bluetooth@1.0-service  E  vendor storage read success
2024-03-26 20:14:34.316   277-290   android.ha....0-service and...ardware.bluetooth@1.0-service  E  Got local bdaddr for vendor storage 22:22:D1:CC:6E:CF
2024-03-26 20:14:34.316   277-290   android.ha....0-service and...ardware.bluetooth@1.0-service  D  get_local_address: Trying /data/misc/bluetooth/bdaddr
2024-03-26 20:14:34.317   277-290   libbt_vendor            and...ardware.bluetooth@1.0-service  I  RTKBT_RELEASE_NAME: 20201130_BT_ANDROID_11.0
2024-03-26 20:14:34.317   277-290   libbt_vendor            and...ardware.bluetooth@1.0-service  I  init
2024-03-26 20:14:34.319   277-290   bt_h5_int               and...ardware.bluetooth@1.0-service  E  OsAllocateTimer rtk_parse sigev.sigev_notify_thread_id = syscall(__NR_gettid)!
2024-03-26 20:14:34.320   277-290   chatty                  and...ardware.bluetooth@1.0-service  I  uid=1002(bluetooth) HwBinder:277_1 identical 3 lines
2024-03-26 20:14:34.320   277-290   bt_h5_int               and...ardware.bluetooth@1.0-service  E  OsAllocateTimer rtk_parse sigev.sigev_notify_thread_id = syscall(__NR_gettid)!
2024-03-26 20:14:34.320   277-290   rtk_parse               and...ardware.bluetooth@1.0-service  I  RTKBT_RELEASE_NAME: 20200318_BT_ANDROID_10.0
2024-03-26 20:14:34.321   277-290   libbt_vendor            and...ardware.bluetooth@1.0-service  E  bt_wake_up_host_mode_set(1)
2024-03-26 20:14:34.321   277-290   bt_upio                 and...ardware.bluetooth@1.0-service  E  bt_wake_up_host_mode_set
2024-03-26 20:14:34.321   277-290   bt_upio                 and...ardware.bluetooth@1.0-service  E  bt_wake_up_host_mode_set path:/proc/bluetooth/sleep/lpm
2024-03-26 20:14:34.322   277-290   bt_upio                 and...ardware.bluetooth@1.0-service  E  bt_wake_up_host_mode_set fd:8 = open(path, O_RDWR): open(/proc/bluetooth/sleep/lpm) success
2024-03-26 20:14:34.322   277-290   bt_upio                 and...ardware.bluetooth@1.0-service  E  bt_wake_up_host_mode_set buffer:49
2024-03-26 20:14:34.322   277-290   libbt_vendor            and...ardware.bluetooth@1.0-service  E  rtk_btsnoop_dump = 0, rtk_btsnoop_save_log = 0
2024-03-26 20:14:34.322   277-290   android.ha...h@1.0-impl and...ardware.bluetooth@1.0-service  D  Open vendor library loaded
2024-03-26 20:14:34.548   277-290   libbt_vendor            and...ardware.bluetooth@1.0-service  D  set power off and delay 200ms
2024-03-26 20:14:34.882   277-290   libbt_vendor            and...ardware.bluetooth@1.0-service  D  set power on and delay 1000ms
2024-03-26 20:14:34.882   277-290   bt_userial_vendor       and...ardware.bluetooth@1.0-service  I  userial vendor open: opening /dev/ttyS0
2024-03-26 20:14:34.883   277-290   bt_userial_vendor       and...ardware.bluetooth@1.0-service  I  userial vendor open: with HW flowctrl OFF
2024-03-26 20:14:34.883   277-290   bt_userial_vendor       and...ardware.bluetooth@1.0-service  I  device fd = 8 open
2024-03-26 20:14:34.885   277-290   bt_service              and...ardware.bluetooth@1.0-service  D  OsAllocateTimer bt_service sigev.sigev_notify_thread_id = syscall(__NR_gettid)!
2024-03-26 20:14:34.887   277-290   bt_service              and...ardware.bluetooth@1.0-service  D  RTK_btservice_init init done!
2024-03-26 20:14:34.888   277-290   bt_hwcfg_uart           and...ardware.bluetooth@1.0-service  D  RTKBT_RELEASE_NAME: 20201130_BT_ANDROID_11.0
2024-03-26 20:14:34.888   277-290   bt_hwcfg_uart           and...ardware.bluetooth@1.0-service  D  
                                                                                                    Realtek libbt-vendor_uart Version 5.1.1 
2024-03-26 20:14:34.888   277-290   bt_hwcfg_uart           and...ardware.bluetooth@1.0-service  D  hw_config_start, transtype = 0x11 

//错误日志
2024-03-26 20:14:38.400   277-1933  bt_hwcfg_uart           and...ardware.bluetooth@1.0-service  E  hw_config_cback, status = 3


2024-03-26 20:14:38.400   277-1933  android.ha...h@1.0-impl and...ardware.bluetooth@1.0-service  D  OnFirmwareConfigured result: 1
2024-03-26 20:14:38.400   277-1933  android.ha...h@1.0-impl and...ardware.bluetooth@1.0-service  I  Firmware configured in 3.512s
--------- beginning of crash

//错误日志
2024-03-26 20:14:39.404   277-1933  android.ha...h@1.0-impl and...ardware.bluetooth@1.0-service  E  VendorInterface -> Unable to call initializationComplete()
2024-03-26 20:14:39.404   277-1933  android.ha...h@1.0-impl and...ardware.bluetooth@1.0-service  I  OnFirmwareConfigured: lpm_timeout_ms 0
2024-03-26 20:14:39.404   277-1933  android.ha...h@1.0-impl and...ardware.bluetooth@1.0-service  D  OnFirmwareConfigured Calling StartLowPowerWatchdog()

```

hardware/realtek/rtkbt/code/libbt-vendor/src/hardware_uart.c


```c

void hw_config_start(char transtype)
{
    memset(&hw_cfg_cb, 0, sizeof(bt_hw_cfg_cb_t));
    hw_cfg_cb.dl_fw_flag = 1;
    hw_cfg_cb.chip_type = CHIPTYPE_NONE;
    BTVNDDBG("RTKBT_RELEASE_NAME: %s",RTKBT_RELEASE_NAME);
    BTVNDDBG("\nRealtek libbt-vendor_uart Version %s \n",RTK_VERSION);
    HC_BT_HDR  *p_buf = NULL;
    uint8_t     *p;

    BTVNDDBG("hw_config_start, transtype = 0x%x \n", transtype);

}

void hw_config_cback(void *p_mem)
{


    if(opcode == HCI_VSC_H5_INIT) {
        if(status != 0) {
          ALOGE("%s, status = %d", __func__, status);   // 错误打印位置
          if ((bt_vendor_cbacks) && (p_evt_buf != NULL))
              bt_vendor_cbacks->dealloc(p_evt_buf);
          if(rtkbt_auto_restart) {
              if(bt_vendor_cbacks)
                  bt_vendor_cbacks->fwcfg_cb(BT_VND_OP_RESULT_FAIL);
              kill(getpid(), SIGKILL);
          }
          return;
        }
    }

}

```


## 蓝牙驱动

BT 电源控制驱动位于： net/rfkill/rfkill-bt.c ， 代码会生成节点/sys/class/rfkill/rfkill0/state。

* echo 1 > /sys/class/rfkill/rfkill0/state 可以手动给蓝牙模块上电
* echo 0 > /sys/class/rfkill/rfkill0/state 可以手动给蓝牙模块下电

系统在打开蓝牙时候，会自动执行上电过程。

```txt

kernel/net/rfkill$ tree
.
├── core.c
├── input.c
├── Kconfig
├── Makefile
├── rfkill-bt.c
├── rfkill-gpio.c
├── rfkill.h
└── rfkill-wlan.c

```

**错误日志**

```txt

2024-03-26 18:53:09.277     0-0     [BT_RFKILL]             kernel                               I  bt shut off power
2024-03-26 18:53:09.501  2098-2098  libbt_vendor            and...ardware.bluetooth@1.0-service  D  set power off and delay 200ms
2024-03-26 18:53:09.502     0-0     [BT_RFKILL]             kernel                               I  rfkill_rk_set_power: set bt wake_host high!
2024-03-26 18:53:09.529     0-0     [BT_RFKILL]             kernel                               I  ENABLE UART_RTS
2024-03-26 18:53:09.635     0-0     [BT_RFKILL]             kernel                               I  DISABLE UART_RTS
2024-03-26 18:53:09.635     0-0     [BT_RFKILL]             kernel                               I  bt turn on power
2024-03-26 18:53:09.635     0-0     [BT_RFKILL]             kernel                               I  Request irq for bt wakeup host
2024-03-26 18:53:09.635     0-0     [BT_RFKILL]             kernel                               I  ** disable irq

// 上电
2024-03-26 18:53:09.835  2098-2098  libbt_vendor            and...ardware.bluetooth@1.0-service  D  set power on and delay 1000ms
2024-03-26 18:53:09.835  2098-2098  bt_userial_vendor       and...ardware.bluetooth@1.0-service  I  userial vendor open: opening /dev/ttyS0
2024-03-26 18:53:09.836  2098-2098  bt_userial_vendor       and...ardware.bluetooth@1.0-service  I  userial vendor open: with HW flowctrl OFF
2024-03-26 18:53:09.836  2098-2098  bt_userial_vendor       and...ardware.bluetooth@1.0-service  I  device fd = 8 open
2024-03-26 18:53:09.840  2098-2098  bt_service              and...ardware.bluetooth@1.0-service  D  OsAllocateTimer bt_service sigev.sigev_notify_thread_id = syscall(__NR_gettid)!
2024-03-26 18:53:09.841  2098-2098  bt_service              and...ardware.bluetooth@1.0-service  D  RTK_btservice_init init done!
2024-03-26 18:53:09.842  2098-2098  bt_hwcfg_uart           and...ardware.bluetooth@1.0-service  D  RTKBT_RELEASE_NAME: 20201130_BT_ANDROID_11.0
2024-03-26 18:53:09.842  2098-2098  bt_hwcfg_uart           and...ardware.bluetooth@1.0-service  D  
                                                                                                    Realtek libbt-vendor_uart Version 5.1.1 
2024-03-26 18:53:09.842  2098-2098  bt_hwcfg_uart           and...ardware.bluetooth@1.0-service  D  hw_config_start, transtype = 0x11 

// 错误日志
2024-03-26 18:53:13.353  2098-2170  bt_hwcfg_uart           and...ardware.bluetooth@1.0-service  E  hw_config_cback, status = 3

```

**正常日志**

```txt

2024-03-26 18:48:59.227   271-297   libbt_vendor            and...ardware.bluetooth@1.0-service  D  set power off and delay 200ms
2024-03-26 18:48:59.229     0-0     [BT_RFKILL]             kernel                               I  rfkill_rk_set_power: set bt wake_host high!
2024-03-26 18:48:59.255     0-0     [BT_RFKILL]             kernel                               I  ENABLE UART_RTS
2024-03-26 18:48:59.362     0-0     [BT_RFKILL]             kernel                               I  DISABLE UART_RTS
2024-03-26 18:48:59.362     0-0     [BT_RFKILL]             kernel                               I  bt turn on power
2024-03-26 18:48:59.362     0-0     [BT_RFKILL]             kernel                               I  Request irq for bt wakeup host
2024-03-26 18:48:59.362     0-0     [BT_RFKILL]             kernel                               I  ** disable irq
2024-03-26 18:48:59.564     0-0     <no-tag>                kernel                               W  ttyS0 - failed to request DMA, use interrupt mode
2024-03-26 18:48:59.562   271-297   libbt_vendor            and...ardware.bluetooth@1.0-service  D  set power on and delay 1000ms
2024-03-26 18:48:59.562   271-297   bt_userial_vendor       and...ardware.bluetooth@1.0-service  I  userial vendor open: opening /dev/ttyS0
2024-03-26 18:48:59.563   271-297   bt_userial_vendor       and...ardware.bluetooth@1.0-service  I  userial vendor open: with HW flowctrl OFF
2024-03-26 18:48:59.563   271-297   bt_userial_vendor       and...ardware.bluetooth@1.0-service  I  device fd = 8 open
2024-03-26 18:48:59.565   271-297   bt_service              and...ardware.bluetooth@1.0-service  D  OsAllocateTimer bt_service sigev.sigev_notify_thread_id = syscall(__NR_gettid)!
2024-03-26 18:48:59.567   271-297   bt_service              and...ardware.bluetooth@1.0-service  D  RTK_btservice_init init done!
2024-03-26 18:48:59.567   271-297   bt_hwcfg_uart           and...ardware.bluetooth@1.0-service  D  RTKBT_RELEASE_NAME: 20201130_BT_ANDROID_11.0
2024-03-26 18:48:59.568   271-297   bt_hwcfg_uart           and...ardware.bluetooth@1.0-service  D  
                                                                                                    Realtek libbt-vendor_uart Version 5.1.1 
2024-03-26 18:48:59.568   271-297   bt_hwcfg_uart           and...ardware.bluetooth@1.0-service  D  hw_config_start, transtype = 0x11 
2024-03-26 18:48:59.594   271-1967  bt_hwcfg_uart           and...ardware.bluetooth@1.0-service  D  hw_cfg_cb.state = 1
2024-03-26 18:48:59.599   271-1967  bt_hwcfg_uart           and...ardware.bluetooth@1.0-service  D  hw_cfg_cb.state = 2
2024-03-26 18:48:59.599   271-1967  bt_hwcfg_uart           and...ardware.bluetooth@1.0-service  D  lmp_subversion = 0x8821 hw_cfg_cb.hci_version = 0x8 hw_cfg_cb.hci_revision = 0xc
2024-03-26 18:48:59.604   271-1967  bt_hwcfg_uart           and...ardware.bluetooth@1.0-service  D  hw_cfg_cb.state = 3
2024-03-26 18:48:59.604   271-1967  bt_hwcfg_uart           and...ardware.bluetooth@1.0-service  D  hw_config_cback chip_id of the IC:2
2024-03-26 18:48:59.604   271-1967  bt_hwcfg_uart           and...ardware.bluetooth@1.0-service  I  check_match_state return 1(cfg->lmp_subversion:0x8821 cfg->hci_vesion:0x8 cfg->hci_revision:0xc cfg->chip_type:0x1f mask:00000000)
2024-03-26 18:48:59.604   271-1967  bt_hwcfg_uart           and...ardware.bluetooth@1.0-service  I  get_patch_entry(lmp_subversion:0x8821 hci_vesion:0x8 cfg->hci_revision:0xc chip_type:0x1f)
2024-03-26 18:48:59.604   271-1967  bt_hwcfg_uart           and...ardware.bluetooth@1.0-service  I  get_patch_entry return(patch_name:rtl8821cs_fw config_name:rtl8821cs_config mac_offset:0x44)

```

从以上报错日志可以分析出，hw_config_start函数执行报错，hw_config_cback, status = 3是具体报错内容

**排查DTS驱动, 重点关注串口**

rk3399.dtsi

```dts

                uart0 {
                        uart0_xfer: uart0-xfer {
                                rockchip,pins =
                                        <2 RK_PC0 1 &pcfg_pull_up>,
                                        <2 RK_PC1 1 &pcfg_pull_up>;
                        };

                        uart0_cts: uart0-cts {
                                rockchip,pins =
                                        <2 RK_PC2 1 &pcfg_pull_none>;
                        };

                        uart0_rts: uart0-rts {
                                rockchip,pins =
                                        <2 RK_PC3 1 &pcfg_pull_none>;
                        };
                };


```

rk3399-evb.dtsi

```dts

        wireless-wlan {
                compatible = "wlan-platdata";
                rockchip,grf = <&grf>;
                wifi_chip_type = "rtl8821cs";
                sdio_vref = <1800>;
                WIFI,host_wake_irq = <&gpio0 3 GPIO_ACTIVE_HIGH>; /* GPIO0_a3 */
                status = "okay";
        };

        wireless-bluetooth {
                compatible = "bluetooth-platdata";
                clocks = <&rk808 1>;
                clock-names = "ext_clock";
                //wifi-bt-power-toggle;
                uart_rts_gpios = <&gpio2 19 GPIO_ACTIVE_LOW>; /* GPIO2_C3 */
                pinctrl-names = "default", "rts_gpio";
                pinctrl-0 = <&uart0_rts>;
                pinctrl-1 = <&uart0_gpios>;
                //BT,power_gpio  = <&gpio3 19 GPIO_ACTIVE_HIGH>; /* GPIOx_xx */
                BT,reset_gpio    = <&gpio0 9 GPIO_ACTIVE_HIGH>; /* GPIO0_B1 */
                BT,wake_gpio     = <&gpio2 27 GPIO_ACTIVE_HIGH>; /* GPIO2_D3 BT_WAKE */
                BT,wake_host_irq = <&gpio0 4 GPIO_ACTIVE_HIGH>; /* GPIO0_A4 */
                status = "okay";
        };


&pinctrl {

        wireless-bluetooth {
                uart0_gpios: uart0-gpios {
                        rockchip,pins = <2 RK_PC3 RK_FUNC_GPIO &pcfg_pull_none>;
                };
        };
}

```






















