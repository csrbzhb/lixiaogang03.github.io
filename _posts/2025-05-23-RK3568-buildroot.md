---
layout:     post
title:      RK3568 Buildroot
subtitle:   linux
date:       2025-05-23
author:     LXG
header-img: img/post-bg-xiaomi.jpg
catalog: true
tags:
    - linux
---

Rockchip_Developer_Guide_Linux_Software_CN.pdf

Rockchip_Developer_Guide_Buildroot_CN.pdf

## buildroot 添加 ffmpeg

```diff

diff --git a/buildroot/configs/rockchip/multimedia/ffmpeg.config b/buildroot/configs/rockchip/multimedia/ffmpeg.config
new file mode 100644
index 000000000..34eadb644
--- /dev/null
+++ b/buildroot/configs/rockchip/multimedia/ffmpeg.config
@@ -0,0 +1,2 @@
+BR2_PACKAGE_FFMPEG=y
+BR2_PACKAGE_FFMPEG_SWSCALE=y
diff --git a/buildroot/configs/rockchip_rk3568_defconfig b/buildroot/configs/rockchip_rk3568_defconfig
index 0637322b6..4e44f2449 100644
--- a/buildroot/configs/rockchip_rk3568_defconfig
+++ b/buildroot/configs/rockchip_rk3568_defconfig
@@ -6,6 +6,7 @@
 #include "fs/vfat.config"
 #include "gpu/gpu.config"
 #include "multimedia/audio.config"
+#include "multimedia/ffmpeg.config"
 #include "multimedia/camera.config"
 #include "multimedia/gst/audio.config"
 #include "multimedia/gst/camera.config"

```

**编译**

./build.sh buildroot

## USB Gadget

Rockchip_Quick_Start_Linux_USB_Gadget_CN.pdf

Rockchip_Trouble_Shooting_Linux4.19_USB_Gadget_UVC_CN.pdf

**kernel/arch/arm64/configs/rockchip_linux_defconfig**

```sh

CONFIG_USB_GADGET=y
CONFIG_USB_GADGET_DEBUG_FILES=y
CONFIG_USB_GADGET_VBUS_DRAW=500
CONFIG_USB_CONFIGFS=y
CONFIG_USB_CONFIGFS_UEVENT=y
CONFIG_USB_CONFIGFS_ACM=y
CONFIG_USB_CONFIGFS_RNDIS=y
CONFIG_USB_CONFIGFS_MASS_STORAGE=y
CONFIG_USB_CONFIGFS_F_FS=y
CONFIG_USB_CONFIGFS_F_UAC1=y
CONFIG_USB_CONFIGFS_F_UAC1_LEGACY=y
CONFIG_USB_CONFIGFS_F_UAC2=y
CONFIG_USB_CONFIGFS_F_MIDI=y
CONFIG_USB_CONFIGFS_F_HID=y
CONFIG_USB_CONFIGFS_F_UVC=y


```

**RKScript中，有三个USB相关文件：**

```sh

S50usbdevice # /etc/init.d/ 使用时，配合同级目录的.usb_config使用
usbdevice # /usr/bin/
61-usbdevice.rules # /lib/udev/rules.d/

#还有两个相关文件需要用户自建或修改
.usb_config # /etc/init.d/
/tmp/.usb_config # S50usbdevice 自动生成

```

**./buildroot/output/rockchip_rk3568/target/etc/init.d/S50usbdevice.sh**

```sh

#!/bin/sh
### BEGIN INIT INFO
# Provides:       usbdevice
# Required-Start: $local_fs $syslog
# Required-Stop:  $local_fs
# Default-Start:  S
# Default-Stop:   K
# Description:    Manage USB device functions
### END INIT INFO

case "$1" in
	start|stop|restart)
		/sbin/start-stop-daemon -Sbx /usr/bin/usbdevice $1
		;;
	*)
		echo "Usage: [start|stop|restart]" >&2
		exit 3
		;;
esac

:

```

**.usb_config 支持的配置项**


```sh

#!/bin/sh

# 启用 ADB 调试功能
usb_adb_en=1

# 启用 USB 音频类 1.0（兼容性好）
usb_uac1_en=0

# 启用 USB 音频类 2.0（高质量音频）
usb_uac2_en=1

# 启用 USB 网络共享功能（RNDIS 协议）
usb_rndis_en=1

# 启用 MTP 模式（媒体文件传输）
usb_mtp_en=1

# 启用 USB 大容量存储（UMS，如 U 盘模式）
usb_ums_en=0

# 启用 USB 串口通信（ACM）
usb_acm_en=1

# 启用 USB 视频类（UVC，支持摄像头）
usb_uvc_en=1

```


## 配置USB Gadget UVC

```diff

diff --git a/buildroot/board/rockchip/rk3566_rk3568/fs-overlay/etc/init.d/.usb_config b/buildroot/board/rockchip/rk3566_rk3568/fs-overlay/etc/init.d/.usb_config
index 3de3a0bb7..a41345923 100644
--- a/buildroot/board/rockchip/rk3566_rk3568/fs-overlay/etc/init.d/.usb_config
+++ b/buildroot/board/rockchip/rk3566_rk3568/fs-overlay/etc/init.d/.usb_config
@@ -1 +1 @@
-usb_adb_en
+usb_uvc_en
diff --git a/external/rkscript/S50usbdevice.sh b/external/rkscript/S50usbdevice.sh
index 9679d40b9..282d49cdc 100755
--- a/external/rkscript/S50usbdevice.sh
+++ b/external/rkscript/S50usbdevice.sh
@@ -10,7 +10,9 @@
 
 case "$1" in
        start|stop|restart)
+               /usr/bin/uvc_config.sh
                /sbin/start-stop-daemon -Sbx /usr/bin/usbdevice $1
+               /sbin/start-stop-daemon --start --quiet --background --exec /usr/bin/uvc_app -- 640 480
                ;;
        *)
                echo "Usage: [start|stop|restart]" >&2


```

**上述修改配置好后 RK3568 USB 插入后的日志**

```bash

[   20.486987] dwc3 fcc00000.dwc3: device reset
[   20.668248] dwc3 fcc00000.dwc3: device reset
[   20.865929] android_work: sent uevent USB_STATE=CONNECTED
[   20.899630] configfs-gadget gadget: uvc: uvc_function_set_alt(0, 0)
[   20.899709] configfs-gadget gadget: uvc: reset UVC Control
[   20.899750] configfs-gadget gadget: uvc: uvc_function_set_alt(1, 0)
[   20.899938] android_work: sent uevent USB_STATE=CONFIGURED

```

**ubuntu lsusb命令显示的 usb 设备(未被识别成UVC摄像头)**

```bash

Bus 001 Device 017: ID 2207:0005 Fuzhou Rockchip Electronics Company rk3xxx

```

**android端日志**

```bash

[  128.409060] usb 7-1: new high-speed USB device number 4 using xhci-hcd
[  128.551376] usb 7-1: New USB device found, idVendor=2207, idProduct=0005, bcdDevice= 3.10
[  128.551457] usb 7-1: New USB device strings: Mfr=1, Product=2, SerialNumber=3
[  128.551485] usb 7-1: Product: UVC
[  128.551508] usb 7-1: Manufacturer: Rockchip
[  128.551529] usb 7-1: SerialNumber: 2020
[  128.638262] input: UVC: UVC Camera as /devices/platform/usbdrd/fcc00000.dwc3/xhci-hcd.6.auto/usb7/7-1/7-1:1.0/input/input8

```

## 打开工具

Ubuntu: guvcview

Windows: Amcap

Android: com.shenyaocn.android.usbdualcamera.apk

![guvcview](/images/hardware/camera/guvcview.png)

## Android

**默认生成的节点**

```bash

rk3568_r:/ $ ls /dev/video*
/dev/video0  /dev/video1

```

**dumpsys camera**

```bash



```





















